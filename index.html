<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google</title>
    <!-- Tailwind CSS CDN for modern and responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* استفاده از فونت Vazirmatn به عنوان اولویت، با fallback قوی به فونت‌های سیستمی فارسی/عربی */
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        
        body {
            /* استک فونت مقاوم: Tahoma و Arial برای پشتیبانی مطمئن از فارسی، سپس Vazirmatn و بقیه */
            font-family: 'Vazirmatn', Tahoma, Arial, 'Roboto', sans-serif;
            background-color: #ffffff;
            color: #202124;
        }

        /* استايل براي نوار پيمايش بالا که حالت جستجو يا اخبار را نشان مي‌دهد */
        .tab-button {
            /* تنظيمات اصلي: پدينگ، مکان‌نما، اندازه فونت، خط زيرين شفاف، رنگ متن پيش‌فرض خاکستري */
            @apply p-3 cursor-pointer text-sm font-medium border-b-4 border-transparent text-gray-500 transition-colors duration-150;
        }

        /* حالت هاور براي تمام دکمه‌ها: نمايش خط خاکستري ملايم */
        .tab-button:hover {
            /* اين خط زيرين ملايم فقط هنگام هاور ظاهر مي‌شود */
            border-bottom-color: #e0e0e0; 
        }
        
        /* حالت فعال: نمايش خط آبي/نيلي پررنگ و تغيير رنگ متن (اولويت بالاتر با !important) */
        .tab-active {
            /* هنگام فعال بودن، خط آبي پررنگ و رنگ متن آبي پررنگ مي‌شود */
            @apply text-indigo-700 border-indigo-700 !important;
        }

        /* استايل براي محل نمايش اطلاعات کاربر (تصحيح شده) */
        #user-info-display {
            color: #9c9c9c; /* خاکستری روشن برای مخفی بودن نسبی */
            font-size: 0.7rem;
            direction: ltr; /* اطمینان از نمایش صحیح متن انگلیسی */
            font-family: 'Roboto', monospace; /* استفاده از فونت انگلیسی مطمئن */
        }

        /* انيميشن محو شدن براي نتيجه رمزگشايي - 0.5 ثانيه */
        .fade-out {
            opacity: 0;
            transition: opacity 0.5s ease-out; 
        }
        
        #decrypted-text {
            /* استک فونت محکم برای متون رمزگشایی شده */
            direction: rtl; 
            font-family: 'Vazirmatn', Tahoma, Arial, sans-serif; 
        }
        
        .main-header {
            @apply w-full border-b-0;
        }
        
        .nav-bar {
            @apply border-b border-gray-200;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- Header & Navigation Bar (Simulating Google Search UI) -->
    <header class="main-header w-full">
        <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <!-- Google Logo (Placeholder) -->
            <div class="text-2xl font-semibold text-gray-800">
                <span class="text-blue-500">G</span><span class="text-red-500">o</span><span class="text-yellow-500">o</span><span class="text-blue-500">g</span><span class="text-green-500">l</span><span class="text-red-500">e</span>
            </div>
            
            <!-- User Info (اطلاعات کاربر) -->
            <div id="user-info-display" class="md:inline-block"></div>
        </div>
        
        <!-- Search Tabs (Key for switching modes) -->
        <nav class="nav-bar max-w-6xl mx-auto px-4">
            <div class="flex space-x-6 space-x-reverse">
                <button id="search-tab" class="tab-button tab-active">جستجو</button>
                <button id="news-tab" class="tab-button">رمزگشایی</button>
                <button id="library-tab" class="tab-button">کتابخانه</button> 
                <button id="maps-tab" class="tab-button">نقشه‌ها</button>
            </div>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 w-full max-w-xl px-4 pt-10">
        <!-- Main Search Input -->
        <div class="relative mb-6">
            <input 
                id="search-input" 
                type="text" 
                placeholder="" 
                autocomplete="off" 
                class="w-full p-3 pl-10 border border-gray-300 rounded-full shadow-md focus:shadow-lg focus:border-indigo-500 outline-none text-base"
                autofocus
                disabled 
            >
            <!-- Search Icon -->
            <svg class="w-5 h-5 absolute top-3 left-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>

        <!-- Mode Status & Decrypted Result Area (Now completely empty) -->
        <div id="mode-status" class="text-center mb-6 text-lg font-semibold text-gray-600">
        </div>

        <!-- Decryption Result Display (Hidden initially, appears on News mode success/failure) -->
        <div id="decryption-box" class="hidden p-3 text-center" role="alert">
            <p class="font-bold mb-2"></p>
            <p id="decrypted-text" class="text-base text-gray-800"></p>
        </div>

        <!-- Dynamic Search Results Area -->
        <div id="results-area" class="mt-8">
            <!-- Initial loading message added here -->
             <div class="text-center mt-10" id="initial-loading">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                <p class="text-gray-500">در حال راه‌اندازی برنامه و اتصال امن...</p>
            </div>
        </div>
    </main>

    <!-- Footer (Cleaned up, no hidden output here) -->
    <footer class="w-full mt-auto py-3 border-t border-gray-200 text-center">
        <p class="text-gray-500 text-xs">
            © 2025 Google - <a href="#" class="underline">حريم خصوصي</a> - <a href="#" class="underline">شرايط</a>
        </p>
    </footer>


    <!-- Firebase SDKs & Core Logic -->
    <script type="module">
        // --- واردات ماژول‌هاي فايربيس ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // واردات مورد نیاز برای رصد لحظه‌ای (onSnapshot) و کوئری‌ها
        import { getFirestore, doc, setDoc, getDoc, setLogLevel, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- متغيرهاي گلوبال فايربيس ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAuthReady = false;
        let currentMode = 'encode'; 
        let unsubscribeLibrary = null; // برای نگهداری و قطع کردن شنونده Firestore
        
        // --- عناصر DOM ---
        const searchInput = document.getElementById('search-input');
        const searchTab = document.getElementById('search-tab');
        const newsTab = document.getElementById('news-tab');
        const libraryTab = document.getElementById('library-tab'); 
        const mapsTab = document.getElementById('maps-tab');
        const modeStatus = document.getElementById('mode-status');
        const decryptionBox = document.getElementById('decryption-box');
        const decryptedText = document.getElementById('decrypted-text');
        const userInfoDisplay = document.getElementById('user-info-display');
        const resultsArea = document.getElementById('results-area');
        const initialLoading = document.getElementById('initial-loading'); // عنصر بارگذاری اولیه
        
        // --- پيکربندي و کليد رمز ---
        const SECRET_KEY = "GEMINI-CODE-25"; 
        const START_ASCII = 32; 
        const END_ASCII = 126;  
        const RANGE = END_ASCII - START_ASCII + 1;
        
        // --- تنظيمات کليد نامرئي (Stealth Mode) ---
        const INVISIBLE_CHARS = ['\u200B', '\u200C', '\u200D', '\u2060']; 
        const BASE_N = INVISIBLE_CHARS.length; // 4
        const BASE_36 = '0123456789abcdefghijklmnopqrstuvwxyz'; 
        const STEALTH_TRIGGER_KEY = '\u200B\u200C\u200D\u2060'; 

        // --- توابع رمزگذاري و رمزگشايي Vigenere-like ---

        function base64Encode(str) {
            const utf8Str = unescape(encodeURIComponent(str));
            return btoa(utf8Str);
        }

        function base64Decode(str) {
            try {
                const utf8Str = atob(str);
                return decodeURIComponent(escape(utf8Str));
            } catch (e) {
                return "خطا در رمزگشايي Base64. (Error: Invalid Cipher Format)";
            }
        }

        function getKeyShift(key, index) {
            return (key.charCodeAt(index % key.length) - START_ASCII);
        }

        function encrypt(plaintext) {
            const base64Str = base64Encode(plaintext);
            let ciphertext = "";
            for (let i = 0; i < base64Str.length; i++) {
                let charCode = base64Str.charCodeAt(i);
                if (charCode >= START_ASCII && charCode <= END_ASCII) { 
                    let keyShift = getKeyShift(SECRET_KEY, i);
                    let shiftedCode = charCode - START_ASCII;
                    let newShiftedCode = (shiftedCode + keyShift) % RANGE;
                    ciphertext += String.fromCharCode(newShiftedCode + START_ASCII);
                } else {
                    ciphertext += base64Str[i]; 
                }
            }
            return ciphertext;
        }

        function decrypt(ciphertext) {
            let base64Str = "";
            for (let i = 0; i < ciphertext.length; i++) {
                let charCode = ciphertext.charCodeAt(i);
                if (charCode >= START_ASCII && charCode <= END_ASCII) {
                    let keyShift = getKeyShift(SECRET_KEY, i);
                    let shiftedCode = charCode - START_ASCII;
                    let newShiftedCode = (shiftedCode - keyShift + RANGE) % RANGE;
                    base64Str += String.fromCharCode(newShiftedCode + START_ASCII);
                } else {
                    base64Str += ciphertext[i];
                }
            }
            return base64Decode(base64Str);
        }
        
        // --- توابع Stealth Mode ---

        function generateShortId() {
            // توليد يک UUID کوتاه 16 کاراکتري
            return Date.now().toString(36) + Math.random().toString(36).substring(2, 6) + crypto.randomUUID().substring(0, 4);
        }

        function encodeCharToStealth(char36) {
            const index36 = BASE_36.indexOf(char36);
            if (index36 === -1) return ''; 

            const c1 = Math.floor(index36 / 16); 
            const remaining = index36 % 16;
            const c2 = Math.floor(remaining / 4); 
            const c3 = remaining % 4; 
            
            return INVISIBLE_CHARS[c1] + INVISIBLE_CHARS[c2] + INVISIBLE_CHARS[c3];
        }

        function encodeIdToStealthKey(shortId) {
            let stealthKey = STEALTH_TRIGGER_KEY; 
            for (const char of shortId) {
                stealthKey += encodeCharToStealth(char);
            }
            return stealthKey;
        }

        function decodeStealthKeyToId(stealthText) {
            if (!stealthText.startsWith(STEALTH_TRIGGER_KEY)) return null;
            let encodedBody = stealthText.substring(STEALTH_TRIGGER_KEY.length);
            
            let shortId = '';
            
            for (let i = 0; i < encodedBody.length; i += 3) {
                if (i + 2 >= encodedBody.length) break; 

                const char1 = encodedBody[i];
                const char2 = encodedBody[i+1];
                const char3 = encodedBody[i+2];

                const c1Index = INVISIBLE_CHARS.indexOf(char1);
                const c2Index = INVISIBLE_CHARS.indexOf(char2);
                const c3Index = INVISIBLE_CHARS.indexOf(char3);
                
                if (c1Index === -1 || c2Index === -1 || c3Index === -1) break;

                const index36 = (c1Index * 16) + (c2Index * 4) + c3Index;
                
                if (index36 >= BASE_36.length) break; 
                
                shortId += BASE_36.charAt(index36);
            }
            return shortId.length > 0 ? shortId : null;
        }

        // --- توابع Firestore ---
        
        function getCiphersCollectionRef() {
             // مسیر عمومی برای پیام‌های کتابخانه
             return collection(db, `artifacts/${appId}/public/data/ciphers`);
        }
        
        function getCipherDocRef(cipherId) {
             // مسیر سند خاص برای ذخیره و بازیابی
             return doc(getCiphersCollectionRef(), cipherId);
        }

        async function saveCipherToFirebase(cipherText) {
            const cipherId = generateShortId(); 
            const cipherDocRef = getCipherDocRef(cipherId);
            
            await setDoc(cipherDocRef, {
                cipher: cipherText,
                createdAt: Date.now(), // ثبت زمان برای مرتب‌سازی
                userId: userId, // ذخیره شناسه کاربر
            });
            
            return cipherId;
        }

        async function getCipherFromFirebase(cipherId) {
            const cipherDocRef = getCipherDocRef(cipherId);
            const docSnap = await getDoc(cipherDocRef);
            
            if (docSnap.exists()) {
                return docSnap.data().cipher;
            } else {
                return null;
            }
        }
        
        // --- منطق کتابخانه (Library) ---

        function renderCiphers(ciphers) {
            if (currentMode !== 'library') return;

            if (ciphers.length === 0) {
                resultsArea.innerHTML = `
                    <div class="text-center mt-10 p-6 bg-gray-50 rounded-lg shadow-inner">
                        <p class="text-gray-500 text-lg font-medium">هیچ پیامی در کتابخانه موجود نیست.</p>
                        <p class="text-sm text-gray-400 mt-2">برای اضافه کردن، به تب "جستجو" برگردید و پیامی را رمزگذاری کنید.</p>
                    </div>
                `;
                return;
            }

            const cards = ciphers.map(cipher => {
                const date = cipher.createdAt ? new Date(cipher.createdAt).toLocaleString('fa-IR', {
                    year: 'numeric', month: 'numeric', day: 'numeric', 
                    hour: '2-digit', minute: '2-digit'
                }) : 'نا مشخص';

                // نمایش پیام و جزئیات در کارت
                return `
                    <div class="p-4 mb-4 bg-white border border-gray-200 rounded-lg shadow-md hover:shadow-lg transition duration-200">
                        <p class="text-gray-800 text-base mb-2 break-words" style="direction: rtl;">${cipher.text}</p>
                        <div class="flex justify-between items-center text-xs text-gray-500 pt-2 border-t border-gray-100">
                            <span>تاریخ: ${date}</span>
                            <!-- نمایش قسمتی از ID سند برای مرجع -->
                            <span class="ltr:hidden rtl:block font-mono text-gray-400">${cipher.id.substring(0, 8)}...</span>
                        </div>
                    </div>
                `;
            }).join('');

            // محفظه‌ای با اسکرول برای پیام‌ها
            resultsArea.innerHTML = `<div class="max-h-[60vh] overflow-y-auto pr-2">${cards}</div>`;
        }

        function setupLibraryListener() {
            if (unsubscribeLibrary) {
                unsubscribeLibrary(); // قطع شنونده قبلی
                unsubscribeLibrary = null;
            }
            if (!isAuthReady || !db) return;

            // نمایش لودر در ابتدا
            resultsArea.innerHTML = `
                <div class="text-center mt-10">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                    <p class="text-gray-500">در حال بارگذاری پیام‌های عمومی...</p>
                </div>
            `;
            
            const ciphersRef = getCiphersCollectionRef();
            
            // onSnapshot برای رصد در لحظه
            unsubscribeLibrary = onSnapshot(ciphersRef, (snapshot) => {
                const cipherList = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.cipher) {
                        try {
                            const decryptedText = decrypt(data.cipher);
                            // اضافه کردن فقط پیام‌های معتبر و رمزگشایی شده
                            if (decryptedText && !decryptedText.startsWith("خطا")) {
                                cipherList.push({
                                    id: doc.id,
                                    text: decryptedText,
                                    createdAt: data.createdAt 
                                });
                            }
                        } catch (e) {
                            console.error("Error decrypting cipher in library:", e);
                        }
                    }
                });
                
                // مرتب‌سازی سمت کاربر بر اساس زمان ساخت (جدیدترین‌ها اول)
                cipherList.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                
                renderCiphers(cipherList);
            }, (error) => {
                console.error("Error setting up library listener:", error);
                resultsArea.innerHTML = `<p class="text-center text-red-500 mt-10">خطا در بارگذاري کتابخانه پیام‌ها. (لطفاً اتصال خود را بررسی کنید)</p>`;
            });
        }


        // --- راه‌اندازي فايربيس ---
        async function setupFirebase() {
            try {
                setLogLevel('Debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userInfoDisplay.textContent = `User: ${userId.substring(0, 8)}...`; 
                        isAuthReady = true;

                        // --- منطق حیاتی پس از احراز هویت موفق ---
                        // 1. حذف پیام لودینگ
                        if (initialLoading) {
                            initialLoading.remove();
                        }
                        // 2. فعال‌سازی ورودی
                        searchInput.disabled = false;
                        // 3. تنظیم حالت اولیه برنامه برای تعامل
                        switchMode('encode'); 
                        // --- پایان منطق حیاتی ---

                        if (currentMode === 'library') {
                            setupLibraryListener();
                        }
                    } else {
                        // در صورت عدم احراز هویت اولیه، با توکن اختصاصی یا ناشناس وارد شو
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("خطا در راه‌اندازي فايربيس (Auth/DB):", error);
                // اگر اتصال به Firebase کلاً شکست خورد، یک خطای دائمی نمایش بده
                resultsArea.innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-lg mt-10" role="alert">
                        <p class="font-bold mb-1">خطای بحرانی در اتصال:</p>
                        <p>برنامه نتوانست به سرویس‌های ابری متصل شود. لطفاً اتصال اینترنت خود را بررسی کرده و صفحه را رفرش کنید.</p>
                    </div>
                `;
            }
        }
        
        // --- منطق تغيير حالت (Mode Switching) ---

        function switchMode(mode) {
            // قطع شنونده کتابخانه قبل از تغییر حالت
            if (unsubscribeLibrary) {
                unsubscribeLibrary();
                unsubscribeLibrary = null;
            }
            
            currentMode = mode;
            
            // پاکسازي حالت فعال از همه تب‌ها
            searchTab.classList.remove('tab-active');
            newsTab.classList.remove('tab-active');
            libraryTab.classList.remove('tab-active');
            mapsTab.classList.remove('tab-active');
            
            searchInput.value = '';
            resultsArea.innerHTML = '';
            decryptionBox.classList.add('hidden');
            modeStatus.innerHTML = ''; 

            // تنظيم حالت فعال بر اساس کليک
            let activeTabElement;
            let placeholderText = ""; 
            let inputDirection = 'rtl';
            
            // مدیریت نمایش کادر ورودی
            searchInput.classList.remove('hidden');

            if (mode === 'encode') {
                activeTabElement = searchTab;
                inputDirection = 'rtl';
                placeholderText = "متن خود را وارد و Enter کنید تا رمزگذاری و عمومی شود...";
                
            } else if (mode === 'decode') {
                activeTabElement = newsTab;
                inputDirection = 'ltr'; 
                placeholderText = "کلید نامرئی را اینجا کپی کنید...";
                
            } else if (mode === 'library') {
                activeTabElement = libraryTab;
                inputDirection = 'rtl';
                placeholderText = "جستجو در پیام‌های کتابخانه (فقط نمایش).";
                searchInput.classList.add('hidden'); // پنهان کردن کادر ورودی در حالت کتابخانه
                
                // شروع شنونده کتابخانه
                if (isAuthReady && db) {
                    setupLibraryListener();
                } else if (!isAuthReady) {
                    // نمایش پیام لودینگ اگر Auth هنوز آماده نیست
                     resultsArea.innerHTML = `
                        <div class="text-center mt-10">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-4"></div>
                            <p class="text-gray-500">در انتظار اتصال امن...</p>
                        </div>
                    `;
                }

            } else if (mode === 'maps') {
                activeTabElement = mapsTab;
                inputDirection = 'rtl';
                placeholderText = "نقشه‌ها (عملیات تعریف نشده)";
            }
            
            if (activeTabElement) {
                activeTabElement.classList.add('tab-active');
            }

            // اعمال تغييرات به DOM
            searchInput.placeholder = placeholderText; 
            searchInput.style.direction = inputDirection;
            
            searchInput.focus();
        }

        // --- منطق مشترک براي پردازش ورودي ---
        function handleInput(e) {
            // جلوگیری از پردازش ورودی در حالت کتابخانه
            if (currentMode === 'library' || currentMode === 'maps') return;
            
            decryptionBox.classList.add('hidden');
            resultsArea.innerHTML = ''; // پاکسازي نتايج قبلي
            modeStatus.innerHTML = ''; // حذف هرگونه پيام وضعيت
            
            const query = searchInput.value;

            // 1. منطق رمزگذاري (فقط با Enter در حالت Encode)
            if (currentMode === 'encode' && e.type === 'keydown' && e.key === 'Enter') {
                e.preventDefault(); 
                const queryTrimmed = query.trim();
                if (!queryTrimmed) return; 

                searchInput.value = ''; 
                
                // نمايش فقط لودر (Spinner) براي شبيه‌سازي جستجو
                resultsArea.innerHTML = `
                    <div class="text-center mt-10">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    </div>
                `;

                encryptAndSave(queryTrimmed);
            
            // 2. منطق رمزگشايي (بلافاصله با Input در حالت Decode)
            } else if (currentMode === 'decode' && e.type === 'input') {
                
                clearTimeout(window.decodeTimer); 

                if (query.length === 0) {
                    return;
                }
                
                window.decodeTimer = setTimeout(() => {
                    decryptAndFetch(query);
                }, 250); 
            }
            
            // 3. اگر حالت تصاوير يا نقشه‌ها فعال باشد، هيچ کاري انجام نمي‌دهيم تا طبيعي به نظر برسد.
        }
        
        // --- توابع اصلي پردازش ---

        async function encryptAndSave(plaintext) {
            if (!isAuthReady || !db) {
                // اگر کاربر قبل از آمادگی، تلاش به تعامل کرد، دوباره پیام خطا را نمایش میدهیم
                displayError("خطا: احراز هويت يا پايگاه داده آماده نيست. لطفاً چند لحظه صبر کنید.");
                return;
            }

            try {
                const cipherText = encrypt(plaintext);
                const cipherId = await saveCipherToFirebase(cipherText);
                
                // نمايش خطاي جعلي مرورگر در ناحيه نتايج
                showFakeBrowserError(cipherId);

            } catch (error) {
                console.error("خطا در رمزگذاري و ذخيره:", error);
                displayError("خطا در ذخيره‌سازي رمز در پايگاه داده.");
            }
        }

        async function decryptAndFetch(stealthKeyInput) {
            if (!isAuthReady || !db) {
                displayError("خطا: احراز هويت يا پايگاه داده آماده نيست. لطفاً چند لحظه صبر کنید.");
                return;
            }
            
            const cipherId = decodeStealthKeyToId(stealthKeyInput);

            if (!cipherId) {
                resultsArea.innerHTML = '';
                // در صورت خطا، پيام خطاي نامحسوس را در کادر نمايش مي‌دهيم.
                displayDecryptedResult("خطا در بارگذاري محتوا. ممکن است اتصال ضعيف باشد.", true);
                return;
            }

            // لودر را در ناحيه نتايج نمايش مي‌دهيم (کاملاً شبيه به جستجوي واقعي)
            resultsArea.innerHTML = `
                <div class="text-center mt-10">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-600 mx-auto mb-4"></div>
                    <p class="text-gray-500">در حال بازيابي اطلاعات... (ID: ${cipherId})...</p>
                </div>
            `;
            
            try {
                const cipherText = await getCipherFromFirebase(cipherId);

                if (cipherText) {
                    const decryptedTextResult = decrypt(cipherText);
                    searchInput.value = ''; 
                    // در صورت موفقيت، فقط کادر را نمايش مي‌دهيم.
                    displayDecryptedResult(decryptedTextResult, false); 
                } else {
                    // پيام خطاي نامحسوس در صورت عدم وجود کليد در ديتابيس
                    displayDecryptedResult(`خطا در بازيابي اطلاعات. سرور در دسترس نيست.`, true);
                }
            } catch (error) {
                 console.error("خطا در بازيابي و رمزگشايي:", error);
                 displayDecryptedResult("خطاي غيرمنتظره در ارتباط با پايگاه داده.", true);
            }
        }
        
        // --- توابع کمکي DOM ---

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.top = '0';
            textarea.style.left = '0';
            textarea.style.width = '1px';
            textarea.style.height = '1px';
            textarea.style.opacity = '0'; 
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.setSelectionRange(0, textarea.value.length); 
            let success = false;
            try {
                success = document.execCommand('copy');
            } catch (err) {
                console.error('Failed to copy text', err);
            }
            document.body.removeChild(textarea);
            return success;
        }

        function displayError(message) {
            // این تابع برای خطاهای غیرقابل رفع است که نیاز به نمایش دائمی دارند
            resultsArea.innerHTML = `
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-lg" role="alert">
                    <p class="font-bold mb-1">Error:</p>
                    <p>${message}</p>
                </div>
            `;
        }
        
        // --- توابع جديد براي خطاي جعلي مرورگر در صفحه ---

        function showFakeBrowserError(cipherId) {
            const stealthKey = encodeIdToStealthKey(cipherId);
            const errorId = crypto.randomUUID().substring(0, 12);

            resultsArea.innerHTML = `
                <div class="flex items-start bg-white p-6 border border-gray-300 rounded-lg shadow-xl text-left rtl:text-right" style="direction: ltr;">
                    <!-- Icon -->
                    <svg class="w-8 h-8 text-red-500 mt-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    
                    <!-- Content -->
                    <div class="ml-4 text-gray-800 flex-grow">
                        <h3 class="text-xl font-bold mb-1" style="font-family: 'Roboto', sans-serif;">ERR_CACHE_WRITE_FAILURE</h3>
                        <p class="text-sm mb-3">
                            The search engine could not process the request due to an unhandled security exception (Error Code: <span class="font-mono text-xs">${errorId}</span>). 
                            This may be a temporary issue with browser storage or content policies.
                        </p>
                        
                        <!-- Retry Button (The Copy Mechanism) -->
                        <button id="retry-copy-btn" 
                                class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-md font-medium hover:bg-blue-700 transition-colors shadow-md text-sm">
                            Retry
                        </button>
                        
                        <p id="copy-status-message" class="text-xs mt-3 h-4 text-gray-600">
                            <!-- Status message appears here -->
                        </p>
                    </div>
                </div>
            `;
            
            // افزودن شنونده به دکمه Retry جديد
            const retryButton = document.getElementById('retry-copy-btn');
            const statusMessage = document.getElementById('copy-status-message');
            const originalButtonText = retryButton.textContent; // "Retry"

            retryButton.addEventListener('click', () => {
                if (copyToClipboard(stealthKey)) {
                    // --- تغييرات جديد: حذف پيام متني و فقط تغيير بصري ---
                    statusMessage.innerHTML = ''; 
                    retryButton.classList.remove('bg-blue-600', 'bg-red-600');
                    retryButton.classList.add('bg-green-600');
                    retryButton.textContent = "Copied!"; // نمایش موقت "Copied!"

                    // پاک کردن پيام پس از 3 ثانيه براي بازگشت به حالت اوليه
                    setTimeout(() => {
                        resultsArea.innerHTML = '';
                        // اطمينان از بازگشت دکمه به رنگ آبي اصلي 
                        retryButton.classList.remove('bg-green-600');
                        retryButton.classList.add('bg-blue-600'); 
                        retryButton.textContent = originalButtonText;

                        searchInput.focus();
                    }, 3000);
                    
                } else {
                    // در صورت خطاي کپي، پيام خطا را نمايش مي‌دهيم.
                    statusMessage.innerHTML = '<span class="text-red-600 font-bold">Error:</span> Manual copy failed. Please try reloading.';
                    retryButton.classList.remove('bg-blue-600');
                    retryButton.classList.add('bg-red-600');
                    retryButton.textContent = originalButtonText; 
                }
            });
        }

        function displayDecryptedResult(textResult, isError) {
            
            decryptedText.textContent = textResult;
            decryptionBox.classList.remove('hidden');
            decryptionBox.classList.remove('fade-out'); 
            
            const titleElement = decryptionBox.querySelector('p.font-bold');

            // در حالت موفقيت (Success)
            if (!isError) {
                decryptedText.classList.remove('text-red-500'); 
                decryptedText.classList.add('text-gray-800');
                titleElement.textContent = "";

            // در حالت خطا (Error)
            } else {
                 decryptedText.classList.remove('text-gray-800');
                 decryptedText.classList.add('text-red-500'); 
                 titleElement.textContent = "";
            }

            // منطق 4 ثانيه‌اي: 3.5 ثانيه نمايش + 0.5 ثانيه محو شدن
            setTimeout(() => { 
                // 1. شروع محو شدن
                decryptionBox.classList.add('fade-out'); 
                
                // 2. پنهان کردن کامل بعد از اتمام انيميشن محو شدن (0.5 ثانيه)
                setTimeout(() => {
                    decryptionBox.classList.add('hidden');
                    decryptionBox.classList.remove('fade-out');
                    modeStatus.innerHTML = ''; 
                    searchInput.focus(); 
                }, 500); // 500ms = مدت زمان انيميشن در CSS

            }, 3500); // 3500ms = مدت زمان نمايش قبل از شروع محو شدن
        }

        // --- مديريت رويدادها ---

        searchTab.addEventListener('click', () => switchMode('encode'));
        newsTab.addEventListener('click', () => switchMode('decode'));
        libraryTab.addEventListener('click', () => switchMode('library')); 
        mapsTab.addEventListener('click', () => switchMode('maps'));

        searchInput.addEventListener('keydown', handleInput); 
        searchInput.addEventListener('input', handleInput); 
        
        // --- مقداردهي اوليه ---
        setupFirebase();
        // switchMode('encode'); // این دستور حذف شد تا منتظر آماده شدن احراز هویت بماند
    </script>
</body>
</html>
