<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… Ø§Ø±Ø¬Ø§Ø¹ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ù‡Ù…ÛŒÙ‡ Ú©Ø§Ø±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ØµØ­ÛŒØ­ Ùˆ Ø§Ù†ÛŒÙ…ÛŒØ´Ù†â€ŒÙ‡Ø§ */
        .modal-container {
            z-index: 50; /* Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ù‡Ù…Ù‡ Ø¹Ù†Ø§ØµØ± */
        }
        .modal-container.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-container.active > div {
            transform: translate(0, 0);
        }
        .hidden-view {
            display: none !important;
        }
        .print-only {
            display: none !important;
        }
        @media print {
            body > * {
                display: none;
            }
            #printArea {
                display: block !important;
            }
            .print-only {
                display: block !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    
    <div id="messageBox" class="fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg z-50 transition-all duration-300 shadow-xl w-full max-w-sm text-center hidden" role="alert">
        </div>
    
    <header class="bg-white shadow-md p-4 flex items-center justify-between sticky top-0 z-10">
        <div class="text-2xl font-extrabold text-blue-600">
            Ø³ÛŒØ³ØªÙ… Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø±
        </div>

        <div class="flex items-center space-x-4 space-x-reverse">
            <button onclick="showView('dashboardView')" class="bg-gray-200 text-gray-800 p-2 rounded-lg hover:bg-gray-300 transition shadow-md whitespace-nowrap text-sm">
                ğŸ“ˆ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ù‡Ù†Ø¯Ø³ÛŒÙ†
            </button>
            <button onclick="showMonthlyReport()" class="bg-gray-200 text-gray-800 p-2 rounded-lg hover:bg-gray-300 transition shadow-md whitespace-nowrap text-sm">
                ğŸ“… Ø¢Ù…Ø§Ø± Ù…Ø§Ù‡Ø§Ù†Ù‡
            </button>

            <button onclick="showView('addEngineerModal')" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition shadow-md whitespace-nowrap text-sm admin-only-btn hidden">
                ğŸ‘· Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³ Ø¬Ø¯ÛŒØ¯
            </button>
            <button onclick="showView('assignProjectModal')" class="bg-purple-600 text-white p-2 rounded-lg hover:bg-purple-700 transition shadow-md whitespace-nowrap text-sm admin-only-btn hidden">
                âš™ï¸ Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯
            </button>
            
            <div id="newQuotaButtonContainer" class="admin-only-btn hidden">
                 </div>

            <div id="adminLoginContainer" class="flex items-center">
                </div>
        </div>
    </header>

    <main class="container mx-auto p-4 view-container">
        
        <div id="dashboardView" class="hidden-view">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-r-4 border-blue-500 pr-3">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ù‡Ù†Ø¯Ø³ÛŒÙ†</h2>
            
            <p id="loadingMessage" class="text-center text-xl text-gray-500 p-8">...Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</p>

            <div id="engineerList" class="space-y-4">
                </div>
        </div>

        <div id="addEngineerModal" class="hidden-view">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-r-4 border-blue-500 pr-3">Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³ Ø¬Ø¯ÛŒØ¯</h2>
            
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-lg mx-auto">
                <form id="addEngineerForm">
                    <div class="mb-4">
                        <label for="engineerName" class="block text-sm font-medium text-gray-700 mb-1">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ù…Ù‡Ù†Ø¯Ø³</label>
                        <input type="text" id="engineerName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„ÙŠ Ø§Ø­Ù…Ø¯ÙŠ">
                    </div>
                    <div class="mb-6">
                        <label for="engineerRank" class="block text-sm font-medium text-gray-700 mb-1">Ù¾Ø§ÛŒÙ‡ Ù…Ù‡Ù†Ø¯Ø³ÛŒ (Ø³Ù‡Ù…ÛŒÙ‡)</label>
                        <select id="engineerRank" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="" disabled selected>Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§ÛŒÙ‡...</option>
                            <option value="Ù¾Ø§ÙŠÙ‡ Ø³Ù‡">Ù¾Ø§ÙŠÙ‡ Ø³Ù‡ (Û±Û° Ù…ÛŒÙ„ÛŒÙˆÙ† ØªÙˆÙ…Ø§Ù†)</option>
                            <option value="Ù¾Ø§ÙŠÙ‡ Ø¯Ùˆ">Ù¾Ø§ÙŠÙ‡ Ø¯Ùˆ (Û±Ûµ Ù…ÛŒÙ„ÛŒÙˆÙ† ØªÙˆÙ…Ø§Ù†)</option>
                            <option value="Ù¾Ø§ÙŠÙ‡ ÙŠÚ©">Ù¾Ø§ÙŠÙ‡ ÙŠÚ© (Û²Û° Ù…ÛŒÙ„ÛŒÙˆÙ† ØªÙˆÙ…Ø§Ù†)</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition font-bold">
                        Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³
                    </button>
                    <button type="button" onclick="showView('dashboardView')" class="w-full bg-gray-400 text-white p-3 rounded-lg hover:bg-gray-500 transition font-bold mt-3">
                        Ø§Ù†ØµØ±Ø§Ù
                    </button>
                </form>
            </div>
        </div>
        
        <div id="assignProjectModal" class="hidden-view">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-r-4 border-blue-500 pr-3">Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯</h2>

            <div class="bg-white p-6 rounded-lg shadow-xl max-w-2xl mx-auto">
                <form id="assignProjectForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="mb-4">
                            <label for="jobType" class="block text-sm font-medium text-gray-700 mb-1">Ù†ÙˆØ¹ Ú©Ø§Ø±/Ù†Ù‚Ø´Ù‡</label>
                            <select id="jobType" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                                <option value="" disabled selected>Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ú©Ø§Ø±...</option>
                                </select>
                        </div>
                        <div class="mb-4">
                            <label for="clientName" class="block text-sm font-medium text-gray-700 mb-1">Ù†Ø§Ù… Ù…ØªÙ‚Ø§Ø¶ÛŒ / Ù¾Ù„Ø§Ú© Ø«Ø¨ØªÛŒ</label>
                            <input type="text" id="clientName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ø­Ù…Ø¯ Ú©Ø±ÙŠÙ…ÙŠ">
                        </div>
                    </div>
                    
                    <div id="dynamicInputs" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        </div>

                    <button type="submit" class="w-full bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-700 transition font-bold mt-6">
                        Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø±
                    </button>
                    
                </form>

                <div id="assignmentResult" class="mt-6 p-4 border rounded-lg bg-gray-50 hidden">
                    <p class="font-bold text-lg text-gray-800 mb-1">Ù†ØªÛŒØ¬Ù‡ Ø§Ø±Ø¬Ø§Ø¹:</p>
                    <p id="resultText" class="text-gray-700"></p>
                </div>
                
                <button type="button" onclick="showView('dashboardView')" class="w-full bg-gray-400 text-white p-3 rounded-lg hover:bg-gray-500 transition font-bold mt-3">
                    Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
                </button>
            </div>
        </div>
        
        <div id="monthlyReportView" class="hidden-view">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-r-4 border-blue-500 pr-3">Ú¯Ø²Ø§Ø±Ø´ Ùˆ Ø¢Ù…Ø§Ø± Ù…Ø§Ù‡Ø§Ù†Ù‡</h2>
            <p class="text-center text-gray-600 p-8">Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ù…Ù„ØŒ Ù„Ø·ÙØ§Ù‹ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ "Ø¢Ù…Ø§Ø± Ù…Ø§Ù‡Ø§Ù†Ù‡" Ø¯Ø± Ù†ÙˆØ§Ø± Ø¨Ø§Ù„Ø§ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ø± Ù¾Ù†Ø¬Ø±Ù‡ Ø¨Ø§Ø² Ø´Ø¯Ù‡ØŒ Ú¯Ø²Ø§Ø±Ø´ Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ùˆ Ú†Ø§Ù¾ Ú©Ù†ÛŒØ¯.</p>
        </div>
        
    </main>

    <div id="detailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none modal-container">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl p-6 transform translate-y-4 transition-transform duration-300 relative">
            <h3 id="modalTitle" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ø±Ù‡Ø§</h3>
            <button onclick="closeModal('detailsModal')" class="absolute top-3 left-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">Ã—</button>
            
            <p id="modalLoadingMessage" class="text-center text-gray-500 p-4">...Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</p>
            <div id="projectsList" class="space-y-3 max-h-96 overflow-y-auto">
                </div>
        </div>
    </div>
    
    <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none modal-container">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 transform translate-y-4 transition-transform duration-300 relative">
            <h3 id="confirmModalTitle" class="text-xl font-bold text-red-600 mb-4 border-b pb-2">ØªØ£ÛŒÛŒØ¯ Ø¹Ù…Ù„ÛŒØ§Øª</h3>
            <button onclick="closeModal('confirmationModal')" class="absolute top-3 left-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">Ã—</button>
            
            <p id="confirmModalMessage" class="text-gray-700 mb-6">Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ</p>
            
            <div class="flex justify-end gap-3">
                <button onclick="closeModal('confirmationModal')" class="bg-gray-400 text-white p-3 rounded-lg hover:bg-gray-500 transition font-bold">
                    Ù„ØºÙˆ
                </button>
                <button id="confirmAcceptBtn" class="bg-red-600 text-white p-3 rounded-lg hover:bg-red-700 transition font-bold">
                    ØªØ£ÛŒÛŒØ¯
                </button>
            </div>
        </div>
    </div>
    
    <div id="printReportModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none modal-container">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl h-[95vh] transform translate-y-4 transition-transform duration-300 relative flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold text-gray-800">Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø±</h3>
                <div class="flex gap-2">
                    <button onclick="printReport()" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition shadow-md">
                        ğŸ–¨ï¸ Ú†Ø§Ù¾ Ú¯Ø²Ø§Ø±Ø´
                    </button>
                    <button onclick="closeModal('printReportModal')" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">Ã—</button>
                </div>
            </div>
            
            <div id="printReportArea" class="flex-1 overflow-y-auto p-6 text-base" style="direction: rtl;">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, runTransaction, query, where, getDocs, increment, writeBatch, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // âš ï¸ Ø¢ÛŒØ¯ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø´Ù…Ø§ (Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ UID Ø§Ú©Ø§Ù†Øª Ø¬ÛŒÙ…ÛŒÙ„ Ø´Ù…Ø§ Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„ ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯)
        const ADMIN_UID = "rl8GBO00j7hZy4iwDnxaSRcKteL2"; 

        // CONFIG OBJECT (ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙØ§ÛŒØ±Ø¨ÛŒØ³ Ø´Ù…Ø§)
        const firebaseConfig = { 
            apiKey: "AIzaSyChV9mCptF4qybDn_yaOhmSz-KI3LhtDEQ",
            authDomain: "database-erjakar.firebaseapp.com",
            projectId: "database-erjakar",
            storageBucket: "database-erjakar.firebasestorage.app",
            messagingSenderId: "1056379437698",
            appId: "1:1056379437698:web:2a6bffc8ea0f1949436a9b",
            measurementId: "G-NS5ZPEFXD8"
        };
        
        // ØªÙ†Ø¸ÙŠÙ…Ø§Øª Ø³Ø±Ø§Ø³Ø±ÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³
        let app, db, auth;
        let currentAuthUser = null; 
        let isAuthReady = false;
        
        // --- Static Data ---
        const PROJECT_COSTS = {
            'Ù†Ù‚Ø´Ù‡ Ú©Ø±ÙˆÚ©ÙŠ': 1,
            'Ù†Ù‚Ø´Ù‡ ØªÚ© Ø®Ø·ÙŠ': 2,
            'Ù†Ù‚Ø´Ù‡ ÙŠÙˆ ØªÙŠ Ø§Ù…': 4, 
        };
        
        const JOB_DETAILS = {
            'Ù†Ù‚Ø´Ù‡ Ú©Ø±ÙˆÚ©ÙŠ': { label: 'Ù…ØªØ±Ø§Ú˜ Ø²Ù…ÙŠÙ† (Ù…ØªØ± Ù…Ø±Ø¨Ø¹):', isAreaRequired: true, organization: 'Ø´Ù‡Ø±Ø¯Ø§Ø±ÙŠ' },
            'Ù†Ù‚Ø´Ù‡ ØªÚ© Ø®Ø·ÙŠ': { label: 'Ù…ØªØ±Ø§Ú˜ Ú©Ù„ Ø²ÙŠØ± Ø¨Ù†Ø§ (Ù…ØªØ± Ù…Ø±Ø¨Ø¹):', isAreaRequired: true, organization: 'Ø´Ù‡Ø±Ø¯Ø§Ø±ÙŠ' },
            'Ù†Ù‚Ø´Ù‡ ÙŠÙˆ ØªÙŠ Ø§Ù…': { label: 'Ù…ØªØ±Ø§Ú˜ Ø²Ù…ÙŠÙ† (Ù…ØªØ± Ù…Ø±Ø¨Ø¹):', isAreaRequired: true, organization: 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†' }, 
        };

        const RANK_QUOTAS = {
            'Ù¾Ø§ÙŠÙ‡ Ø³Ù‡': 10,
            'Ù¾Ø§ÙŠÙ‡ Ø¯Ùˆ': 15,
            'Ù¾Ø§ÙŠÙ‡ ÙŠÚ©': 20,
        };
        
        const RANK_PRIORITY = {
            'Ù¾Ø§ÙŠÙ‡ ÙŠÚ©': 3,
            'Ù¾Ø§ÙŠÙ‡ Ø¯Ùˆ': 2,
            'Ù¾Ø§ÙŠÙ‡ Ø³Ù‡': 1,
        };

        const UTM_ORGANIZATIONS = [
            'Ø§ÙˆÙ‚Ø§Ù Ùˆ Ø§Ù…ÙˆØ±Ø®ÙŠØ±ÙŠÙ‡',
            'Ø¨Ù†ÙŠØ§Ø¯ Ù…Ø³Ú©Ù†',
            'Ø¬Ù‡Ø§Ø¯ Ú©Ø´Ø§ÙˆØ±Ø²ÙŠ',
            'Ù…Ù†Ø§Ø¨Ø¹ Ø·Ø¨ÙŠØ¹ÙŠ',
            'Ø§Ø¯Ø§Ø±Ù‡ Ø«Ø¨Øª Ø§Ø³Ù†Ø§Ø¯ Ùˆ Ø§Ù…Ù„Ø§Ú©',
            'Ù…ÙŠØ±Ø§Ø« ÙØ±Ù‡Ù†Ú¯ÙŠ',
            'Ø´Ù‡Ø±Ø¯Ø§Ø±ÙŠ' 
        ];

        let ENGINEER_COLLECTION, PROJECTS_COLLECTION;
        let allEngineersMap = {};
        let allProjects = [];
        let currentReportData = null; // Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ Ú†Ø§Ù¾

        let detailsModalRef, modalTitleRef, projectsListRef, modalLoadingMessageRef;
        
        
        // ====================================================================
        // === AUTHENTICATION & ACCESS CONTROL FUNCTIONS ===
        // ====================================================================

        /**
         * Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø¢ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù‡Ù…Ø§Ù† Ø§Ø¯Ù…ÛŒÙ† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø§Ø³Øª ÛŒØ§ Ø®ÛŒØ±.
         * @returns {boolean}
         */
        function isCurrentUserAdmin() {
            return currentAuthUser && currentAuthUser.uid === ADMIN_UID;
        }

        /**
         * Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ùˆ Ø¹Ù†Ø§ØµØ± Ù…Ø¯ÛŒØ±ÛŒØªÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø·Ø­ Ø¯Ø³ØªØ±Ø³ÛŒ.
         */
        function handleAccessControl() {
            const adminButtons = document.querySelectorAll('.admin-only-btn');
            const adminLoginContainer = document.getElementById('adminLoginContainer');
            const isAdmin = isCurrentUserAdmin();

            // Ù…Ø®ÙÛŒ/Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ (Ø«Ø¨Øª/Ø§Ø±Ø¬Ø§Ø¹/ØªØ³ÙˆÙŠÙ‡)
            adminButtons.forEach(btn => {
                if (isAdmin) {
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            });

            // Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡ ÙˆØ±ÙˆØ¯/Ø®Ø±ÙˆØ¬ Ø§Ø¯Ù…ÛŒÙ†
            if (adminLoginContainer) {
                if (currentAuthUser && currentAuthUser.uid !== ADMIN_UID && !currentAuthUser.isAnonymous) {
                     // Ø§Ú¯Ø± Ø¨Ø§ Ø§Ú©Ø§Ù†Øª Ú¯ÙˆÚ¯Ù„ Ø¯ÛŒÚ¯Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø§Ø³Øª 
                     adminLoginContainer.innerHTML = `
                        <p id="adminStatus" class="text-sm font-bold text-gray-500 ml-2">(${currentAuthUser.displayName || 'Ø¨Ø§Ø²Ø¯ÙŠØ¯Ú©Ù†Ù†Ø¯Ù‡'})</p>
                        <button onclick="logoutUser()" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition shadow-md whitespace-nowrap text-sm">
                            Ø®Ø±ÙˆØ¬
                        </button>
                     `;
                }
                else if (isAdmin) {
                    // Ø§Ú¯Ø± Ø§Ø¯Ù…ÛŒÙ† Ø§Ø³ØªØŒ Ø¯Ú©Ù…Ù‡ Ø®Ø±ÙˆØ¬ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
                    adminLoginContainer.innerHTML = `
                        <p id="adminStatus" class="text-sm font-bold text-green-700 ml-2">(${currentAuthUser.displayName || 'Ø§Ø¯Ù…ÛŒÙ†'})</p>
                        <button onclick="logoutUser()" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition shadow-md whitespace-nowrap text-sm">
                            Ø®Ø±ÙˆØ¬ Ø§Ø¯Ù…ÛŒÙ†
                        </button>
                    `;
                } else {
                     // Ø§Ú¯Ø± Ù†Ø§Ø´Ù†Ø§Ø³ Ø§Ø³ØªØŒ Ø¯Ú©Ù…Ù‡ ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú¯ÙˆÚ¯Ù„ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
                     adminLoginContainer.innerHTML = `
                        <button onclick="loginWithGoogle()" class="bg-yellow-500 text-gray-800 p-2 rounded-lg hover:bg-yellow-600 transition shadow-md whitespace-nowrap text-sm">
                            ğŸ”‘ ÙˆØ±ÙˆØ¯ Ø¨Ø§ Google
                        </button>
                     `;
                }
            }
        }

        /**
         * ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ø§Ú©Ø§Ù†Øª Ú¯ÙˆÚ¯Ù„
         */
        window.loginWithGoogle = async function() {
            showMessage('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ú¯ÙˆÚ¯Ù„...', 'info');
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                // Ø§Ú¯Ø± Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ² Ø¨Ø§Ø´Ø¯ØŒ onAuthStateChanged Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ú©Ù†ØªØ±Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú¯ÙˆÚ¯Ù„: ", error);
                showMessage('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú¯ÙˆÚ¯Ù„. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 'error');
                // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ù‡ Ø­Ø§Ù„Øª Ù†Ø§Ø´Ù†Ø§Ø³ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†ÛŒÙ… ØªØ§ Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ø¹Ù…ÙˆÙ…ÛŒ Ø­ÙØ¸ Ø´ÙˆØ¯
                if (!currentAuthUser || currentAuthUser.isAnonymous) {
                     await signInAnonymously(auth); 
                }
            }
        }

        /**
         * Ø®Ø±ÙˆØ¬ Ø§Ø² Ù‡Ø± Ø­Ø³Ø§Ø¨ÛŒ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¨Ø§Ø²Ø¯ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡ (Ù†Ø§Ø´Ù†Ø§Ø³)
         */
        window.logoutUser = async function() {
            showMessage('Ø¯Ø± Ø­Ø§Ù„ Ø®Ø±ÙˆØ¬...', 'info');
            try {
                await signOut(auth);
                // Ù¾Ø³ Ø§Ø² Ø®Ø±ÙˆØ¬ØŒ Ø¨Ø§ÛŒØ¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ù‡ Ø­Ø§Ù„Øª Ù†Ø§Ø´Ù†Ø§Ø³ Ø¨Ø±Ú¯Ø±Ø¯ÛŒÙ…
                await signInAnonymously(auth); 
                showMessage('Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯ Ùˆ Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¨Ø§Ø²Ø¯ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡ Ø¨Ø§Ø²Ú¯Ø´ØªÛŒØ¯.', 'info');
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬: ", error);
                showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø®Ø±ÙˆØ¬. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 'error');
            }
        }

        // ====================================================================
        // === UTILITY FUNCTIONS ===
        // ====================================================================

        function formatCost(cost) {
            if (typeof cost !== 'number' || isNaN(cost)) return '0';
            return new Intl.NumberFormat('fa-IR').format(cost.toFixed(2)) + ' Ù….Øª';
        }

        function showMessage(message, type) {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg z-50 transition-all duration-300 shadow-xl w-full max-w-sm text-center';

            switch (type) {
                case 'success':
                    box.classList.add('bg-green-500', 'text-white');
                    break;
                case 'error':
                    box.classList.add('bg-red-500', 'text-white');
                    break;
                case 'info':
                    box.classList.add('bg-blue-500', 'text-white');
                    break;
            }

            box.classList.remove('hidden');

            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        }

        function showView(viewId) {
            document.querySelectorAll('.view-container > div').forEach(view => {
                view.classList.add('hidden-view');
            });
            
            const view = document.getElementById(viewId);
            if (view) {
                 view.classList.remove('hidden-view');
            } else {
                 document.getElementById('dashboardView').classList.remove('hidden-view');
            }
            
            if (viewId === 'assignProjectModal') {
                renderDynamicInputs(document.getElementById('jobType').value);
            }

            closeModal('detailsModal');
            closeModal('printReportModal');
            closeModal('confirmationModal');
        }
        
        window.showView = showView; // Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² HTML

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        function openModal(modalId) {
             const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
        }
        
        function calculateDynamicCost(jobType, area) {
            const baseCost = PROJECT_COSTS[jobType] || 0;
            let finalCost = baseCost;

            if (jobType === 'Ù†Ù‚Ø´Ù‡ Ú©Ø±ÙˆÚ©ÙŠ' && area > 0) {
                 finalCost = baseCost + (area * 0.005);
            } else if (jobType === 'Ù†Ù‚Ø´Ù‡ ØªÚ© Ø®Ø·ÙŠ' && area > 0) {
                 finalCost = baseCost + (area * 0.007);
            } else if (jobType === 'Ù†Ù‚Ø´Ù‡ ÙŠÙˆ ØªÙŠ Ø§Ù…' && area > 0) {
                 finalCost = baseCost + (area * 0.01);
            }
            
            return Math.ceil(finalCost * 10) / 10;
        }


        function renderDynamicInputs(jobType) {
            const container = document.getElementById('dynamicInputs');
            container.innerHTML = ''; 

            if (!jobType) {
                 container.innerHTML = '<p class="text-sm text-gray-500 text-center col-span-2">Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ú©Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÙŠØ¯ ØªØ§ Ø¬Ø²Ø¦ÙŠØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ø´Ø®Øµ Ø´ÙˆØ¯.</p>';
                 return;
            }

            const details = JOB_DETAILS[jobType];
            
            if (details.isAreaRequired) {
                 const areaInput = `
                     <div>
                         <label for="projectArea" class="block text-sm font-medium text-gray-700 mb-1">${details.label}</label>
                         <input type="number" step="1" min="1" id="projectArea" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500" placeholder="Ù…Ø«Ù„Ø§Ù‹: 120">
                     </div>
                   `;
                 container.innerHTML += areaInput;
            }

            let selectedOrganization = details.organization;

            if (details.organization === 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†') {
                 const orgSelect = document.createElement('select');
                 orgSelect.id = 'relatedOrganization';
                 orgSelect.required = true;
                 orgSelect.className = 'w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500';
                 
                 const defaultOption = document.createElement('option');
                 defaultOption.value = '';
                 defaultOption.textContent = 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù† Ù…Ø±Ø¨ÙˆØ·Ù‡...';
                 defaultOption.disabled = true;
                 defaultOption.selected = true;
                 orgSelect.appendChild(defaultOption);

                 UTM_ORGANIZATIONS.forEach(org => {
                     const option = document.createElement('option');
                     option.value = org;
                     option.textContent = org;
                     orgSelect.appendChild(option);
                 });
                 
                 const orgDiv = document.createElement('div');
                 orgDiv.innerHTML = '<label for="relatedOrganization" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø±Ú¯Ø§Ù† Ù…ØªÙ‚Ø§Ø¶ÙŠ Ù†Ù‚Ø´Ù‡ UTM:</label>';
                 orgDiv.appendChild(orgSelect);
                 container.appendChild(orgDiv);
                 selectedOrganization = orgSelect.value;
            }
            
            const initialCost = PROJECT_COSTS[jobType] || 0;
            const costInput = `
                <div>
                    <label for="manualCost" class="block text-sm font-medium text-gray-700 mb-1">Ù‡Ø²ÙŠÙ†Ù‡ Ù†Ù‡Ø§ÙŠÙŠ (Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù† - Ù‚Ø§Ø¨Ù„ ÙˆÙŠØ±Ø§ÙŠØ´):</label>
                    <input type="number" step="0.1" min="0.1" id="manualCost" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500" value="${initialCost.toFixed(1)}">
                </div>
                <div id="calculatedCostInfo" class="text-xs text-gray-500 p-2 border-t mt-2 col-span-2">
                    <span class="font-bold">Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡:</span> ${selectedOrganization}
                </div>
            `;
            container.innerHTML += costInput;

            const projectAreaEl = document.getElementById('projectArea');
            const manualCostEl = document.getElementById('manualCost');

            const updateCost = () => {
                const area = projectAreaEl ? parseFloat(projectAreaEl.value) : 0;
                let calculated = calculateDynamicCost(jobType, area);
                
                if (manualCostEl) {
                    manualCostEl.value = calculated.toFixed(1);
                }
            }

            if (projectAreaEl) {
                projectAreaEl.addEventListener('input', updateCost);
                if (projectAreaEl.value) updateCost();
            }
            
            if (document.getElementById('relatedOrganization')) {
                document.getElementById('relatedOrganization').addEventListener('change', (e) => {
                    document.getElementById('calculatedCostInfo').innerHTML = `<span class="font-bold">Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡:</span> ${e.target.value}`;
                });
            }
        }
        
        document.getElementById('jobType').addEventListener('change', (e) => {
            renderDynamicInputs(e.target.value);
        });
        
        // ====================================================================
        // === CORE FIREBASE INITIALIZATION & AUTHENTICATION ===
        // ====================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            const jobTypeSelect = document.getElementById('jobType');
            Object.keys(PROJECT_COSTS).forEach(jobType => {
                const option = document.createElement('option');
                option.value = jobType;
                option.textContent = jobType;
                jobTypeSelect.appendChild(option);
            });
            
            detailsModalRef = document.getElementById('detailsModal');
            modalTitleRef = document.getElementById('modalTitle');
            projectsListRef = document.getElementById('projectsList');
            modalLoadingMessageRef = document.getElementById('modalLoadingMessage');
            
            initializeFirebase();
        });


        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, (user) => {
                    currentAuthUser = user;
                    isAuthReady = true;
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø§Ø¹Ù…Ø§Ù„ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø± Ø³Ù…Øª Ú©Ù„Ø§ÛŒÙ†Øª
                    handleAccessControl();

                    if (user) {
                        if (isCurrentUserAdmin()) {
                            showMessage(`Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ø¯Ù…ÛŒÙ† (${user.displayName || user.email}) Ù…ØªØµÙ„ Ø´Ø¯ÛŒØ¯. Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯Ù†Ø¯.`, 'success');
                        } else if (user.isAnonymous) {
                             // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ø´Ù†Ø§Ø³ Ø§Ø³ØªØŒ ÙÙ‚Ø· Ø¯Ø± Ø­Ø§Ù„Øª Ø¨Ø§Ø²Ø¯ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯
                            showMessage(`Ø´Ù…Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ø²Ø¯ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡ Ù…ØªØµÙ„ Ø´Ø¯ÛŒØ¯. Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØªÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ù‡Ø³ØªÙ†Ø¯.`, 'info');
                        } else {
                             // Ø§Ú¯Ø± Ø¨Ø§ Ø§Ú©Ø§Ù†Øª Ú¯ÙˆÚ¯Ù„ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø§Ù…Ø§ Ø§Ø¯Ù…ÛŒÙ† Ù†ÛŒØ³ØªØŒ Ø¨Ø§Ø²Ø¯ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡ Ø§Ø³Øª
                             showMessage(`Ø´Ù…Ø§ Ø¨Ø§ Ø­Ø³Ø§Ø¨ ${user.displayName || user.email} ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯ Ùˆ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ø²Ø¯ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø±ÛŒØ¯.`, 'info');
                        }

                        ENGINEER_COLLECTION = collection(db, 'engineers');
                        PROJECTS_COLLECTION = collection(db, 'projects');

                        startRealtimeListeners();
                        showView('dashboardView');
                        
                    } else {
                        // Ø§Ú¯Ø± Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø³ÛŒØ³ØªÙ… ØªÙ„Ø§Ø´ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ø¨Ù‡ ØµÙˆØ±Øª Ù†Ø§Ø´Ù†Ø§Ø³ ÙˆØ§Ø±Ø¯ Ø´ÙˆØ¯ (Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ø¹Ù…ÙˆÙ…ÛŒ)
                        showMessage('Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ù†Ø§Ø´Ù†Ø§Ø³ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§ØªØµØ§Ù„...', 'info');
                        signInAnonymously(auth)
                            .then(() => {
                                 // ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ØŒ onAuthStateChanged Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØµØ¯Ø§ Ø²Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                            })
                            .catch((error) => {
                                console.error("Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ù†Ø§Ø´Ù†Ø§Ø³:", error);
                                showMessage(`Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯: ${error.code} - Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø±ÙˆØ´ "Anonymous" Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„ Firebase ÙØ¹Ø§Ù„ Ø§Ø³Øª.`, 'error');
                            });
                    }
                });

            } catch (e) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³:", e);
                showMessage('Ø®Ø·Ø§: Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.', 'error');
            }
        }
        
        // ====================================================================
        // === REALTIME LISTENERS & RENDERING ===
        // ====================================================================
        
        function startRealtimeListeners() {
            if (!isAuthReady) return;

            const engineersQuery = query(ENGINEER_COLLECTION);
            const projectsQuery = query(PROJECTS_COLLECTION); 

            onSnapshot(engineersQuery, (querySnapshot) => {
                const engineers = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allEngineersMap[doc.id] = { id: doc.id, ...data };
                    engineers.push({ id: doc.id, ...data });
                });
                renderEngineers(engineers);
            }, (error) => {
                console.error("Error listening to engineers collection: ", error);
                showMessage("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ù„ÙŠØ³Øª Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†: " + error.message, 'error');
            });
            
            onSnapshot(projectsQuery, (querySnapshot) => {
                allProjects = [];
                querySnapshot.forEach((doc) => {
                    allProjects.push({ id: doc.id, ...doc.data() });
                });
            }, (error) => {
                console.error("Error listening to projects collection: ", error);
                showMessage("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ù„ÙŠØ³Øª Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§: " + error.message, 'error');
            });
        }


        /**
         * Ø±Ù†Ø¯Ø± Ù„ÙŠØ³Øª Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
         * @param {Array<Object>} engineers 
         */
        function renderEngineers(engineers) {
            const listContainer = document.getElementById('engineerList');
            const loadingMessage = document.getElementById('loadingMessage');
            const quotaBtnContainer = document.getElementById('newQuotaButtonContainer');

            loadingMessage.classList.add('hidden');
            
            if (engineers.length === 0) {
                 listContainer.innerHTML = '<p class="text-center text-xl text-gray-500 p-8">âš ï¸ Ù‡ÙŠÚ† Ù…Ù‡Ù†Ø¯Ø³ÙŠ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
                 quotaBtnContainer.innerHTML = '';
                 return;
            }

            engineers.sort((a, b) => {
                const rankA = RANK_PRIORITY[a.rank] || 0;
                const rankB = RANK_PRIORITY[b.rank] || 0;
                if (rankA !== rankB) {
                    return rankB - rankA;
                }
                return b.debt - a.debt;
            });
            
            let html = '';
            let allDebtsSettled = true;
            const isAdmin = isCurrentUserAdmin();

            engineers.forEach(eng => {
                const quotaMax = RANK_QUOTAS[eng.rank] || 0;
                const remainingQuota = Math.max(0, quotaMax - eng.debt);
                const debtPercent = quotaMax > 0 ? (eng.debt / quotaMax) * 100 : 0;
                const isOverQuota = eng.debt > quotaMax;
                
                if (eng.debt > 0) {
                    allDebtsSettled = false;
                }

                // Ø¯Ú©Ù…Ù‡ ØªØ³ÙˆÛŒÙ‡ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                const resetBtnHtml = isAdmin ? `
                     <button onclick="showConfirmation('resetQuota', '${eng.id}', '${eng.name}')" 
                         class="bg-red-500 text-white p-2 text-sm rounded-lg hover:bg-red-600 transition shadow-md whitespace-nowrap">
                         ØªØ³ÙˆÙŠÙ‡ Ø¨Ø¯Ù‡ÙŠ
                     </button>
                ` : '';

                html += `
                    <div class="p-4 bg-white rounded-lg card flex items-center justify-between transition duration-150 hover:shadow-lg border ${isOverQuota ? 'border-red-500' : 'border-blue-200'}">
                        <div class="flex-1 min-w-0">
                            <h4 class="text-lg font-bold text-gray-800 truncate">${eng.name}</h4>
                            <p class="text-sm text-blue-600 font-semibold">${eng.rank}</p>
                            <p class="text-xs text-gray-500 mt-1">Ø¢Ø®Ø±ÙŠÙ† Ø§Ø±Ø¬Ø§Ø¹: ${eng.lastAssignedProject || 'Ù†Ø¯Ø§Ø±Ø¯'}</p>
                        </div>

                        <div class="w-2/5 mx-4">
                            <div class="text-xs font-semibold flex justify-between mb-1">
                                <span class="${isOverQuota ? 'text-red-600' : 'text-gray-800'}">Ø¨Ø¯Ù‡ÙŠ: ${formatCost(eng.debt)}</span>
                                <span class="text-gray-600">Ø³Ù‡Ù…ÙŠÙ‡: ${formatCost(quotaMax)}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="progress-bar-fill h-2.5 rounded-full ${isOverQuota ? 'bg-red-500' : 'bg-blue-500'}" style="width: ${Math.min(100, debtPercent)}%"></div>
                            </div>
                        </div>

                        <div class="text-right">
                            <p class="text-sm font-semibold ${isOverQuota ? 'text-red-700' : 'text-green-700'}">Ø¨Ø§Ù‚ÙŠÙ…Ø§Ù†Ø¯Ù‡:</p>
                            <p class="text-base font-bold ${isOverQuota ? 'text-red-700' : 'text-green-700'}">${formatCost(remainingQuota)}</p>
                        </div>
                        
                        <div class="ml-4 flex gap-2">
                            <button onclick="showEngineerProjects('${eng.id}', '${eng.name}')" 
                                class="bg-blue-500 text-white p-2 text-sm rounded-lg hover:bg-blue-600 transition shadow-md whitespace-nowrap">
                                Ø¬Ø²Ø¦ÙŠØ§Øª Ú©Ø§Ø±Ù‡Ø§
                            </button>
                            ${resetBtnHtml}
                        </div>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
            
            // Ø¯Ú©Ù…Ù‡ ØªØ³ÙˆÛŒÙ‡ Ø¹Ù…ÙˆÙ…ÛŒ ÙÙ‚Ø· Ø§Ú¯Ø± Ø¨Ø¯Ù‡ÛŒ ØªØ³ÙˆÛŒÙ‡ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ Ùˆ Ú©Ø§Ø±Ø¨Ø± Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø§Ø´Ø¯ØŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
            if (!allDebtsSettled && isAdmin) {
                 quotaBtnContainer.innerHTML = `
                     <button onclick="showConfirmation('resetAllQuotas')" class="bg-red-600 text-white p-2 rounded-lg hover:bg-red-700 transition shadow-md whitespace-nowrap text-sm">
                        ğŸ”„ ØªØ³ÙˆÙŠÙ‡ Ø¹Ù…ÙˆÙ…ÙŠ Ø¨Ø¯Ù‡ÙŠ
                     </button>
                 `;
                 quotaBtnContainer.classList.remove('hidden');
            } else {
                 quotaBtnContainer.innerHTML = '';
                 quotaBtnContainer.classList.add('hidden');
            }
        }
        
        
        // ====================================================================
        // === CORE LOGIC (ADD/ASSIGN/RESET) ===
        // ====================================================================

        // Engineer Submission
        document.getElementById('addEngineerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // ğŸš¨ Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ: ÙÙ‚Ø· Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø§Ø´Ø¯
            if (!isAuthReady || !isCurrentUserAdmin()) {
                showMessage('Ø¯Ø³ØªØ±Ø³ÛŒ Ù„Ø§Ø²Ù… Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³ Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ø¯Ù…ÛŒÙ† ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.', 'error');
                return;
            }

            const name = document.getElementById('engineerName').value.trim();
            const rank = document.getElementById('engineerRank').value;

            if (name === "" || rank === "") {
                showMessage('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÙŠÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÙŠØ¯.', 'error');
                return;
            }
            
            const newEngineer = {
                name: name,
                rank: rank,
                quotaMax: RANK_QUOTAS[rank] || 0,
                debt: 0,
                lastAssignedProject: null,
                userId: ADMIN_UID, 
                createdAt: serverTimestamp(),
            };

            try {
                await addDoc(ENGINEER_COLLECTION, newEngineer);
                showMessage(`Ù…Ù‡Ù†Ø¯Ø³ ${name} Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø«Ø¨Øª Ø´Ø¯.`, 'success');
                document.getElementById('addEngineerForm').reset();
                showView('dashboardView');
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³: ", error);
                showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³: Ù„Ø·ÙØ§Ù‹ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÙŠØ¯ Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù…Ù†ÙŠØªÙŠ (Security Rules) Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯ Ùˆ Ø´Ù…Ø§ Ø§Ø¯Ù…ÙŠÙ† Ù‡Ø³ØªÙŠØ¯.', 'error');
            }
        });


        // Project Assignment
        document.getElementById('assignProjectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // ğŸš¨ Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ: ÙÙ‚Ø· Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø§Ø´Ø¯
            if (!isAuthReady || !isCurrentUserAdmin()) {
                showMessage('Ø¯Ø³ØªØ±Ø³ÛŒ Ù„Ø§Ø²Ù… Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ø¯Ù…ÛŒÙ† ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.', 'error');
                return;
            }
            
            const jobType = document.getElementById('jobType').value;
            const clientName = document.getElementById('clientName').value.trim();
            const projectAreaEl = document.getElementById('projectArea');
            const projectArea = projectAreaEl ? parseFloat(projectAreaEl.value) : 0;
            const manualCost = parseFloat(document.getElementById('manualCost').value);
            const relatedOrganizationEl = document.getElementById('relatedOrganization');
            let organization = JOB_DETAILS[jobType].organization;

            if (organization === 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†' && relatedOrganizationEl) {
                organization = relatedOrganizationEl.value;
            } else if (organization === 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†') {
                showMessage('Ù„Ø·ÙØ§Ù‹ Ø§Ø±Ú¯Ø§Ù† Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÙŠØ¯.', 'error');
                return;
            }

            if (jobType === "" || clientName === "" || isNaN(manualCost) || manualCost <= 0) {
                 showMessage('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÙŠÙ„Ø¯Ù‡Ø§ÙŠ Ø§Ù„Ø²Ø§Ù…ÙŠ Ø±Ø§ Ù¾Ø± Ú©Ù†ÙŠØ¯.', 'error');
                 return;
            }
            
            try {
                const eligibleEngineers = Object.values(allEngineersMap)
                    .filter(eng => {
                        const quotaMax = RANK_QUOTAS[eng.rank] || 0;
                        const remainingQuota = quotaMax - eng.debt;
                        // Ù…Ù‡Ù†Ø¯Ø³ ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÛŒØ· Ø¨Ø§ÛŒØ¯ Ø³Ù‡Ù…ÛŒÙ‡ Ú©Ø§ÙÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
                        return remainingQuota >= manualCost;
                    })
                    .sort((a, b) => a.debt - b.debt); // Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡ Ù…Ù‡Ù†Ø¯Ø³ÛŒ Ú©Ù‡ Ø¨Ø¯Ù‡ÛŒ Ú©Ù…ØªØ±ÛŒ Ø¯Ø§Ø±Ø¯

                if (eligibleEngineers.length === 0) {
                    const resultDiv = document.getElementById('assignmentResult');
                    resultDiv.classList.remove('hidden', 'border-r-4', 'border-green-500');
                    resultDiv.classList.add('border-r-4', 'border-red-500');
                    document.getElementById('resultText').textContent = `Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ù‡ÙŠÚ† Ù…Ù‡Ù†Ø¯Ø³ÙŠ Ø¨Ø§ Ø³Ù‡Ù…ÙŠÙ‡ Ú©Ø§ÙÙŠ (Ø¨Ø§Ù‚ÙŠÙ…Ø§Ù†Ø¯Ù‡ Ø¨ÙŠØ´ØªØ± ÙŠØ§ Ù…Ø³Ø§ÙˆÙŠ ${formatCost(manualCost)}) ÙŠØ§ÙØª Ù†Ø´Ø¯.`;
                    showMessage('Ø®Ø·Ø§: Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ù‡Ù†Ø¯Ø³ ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÙŠØ·.', 'error');
                    return;
                }
                
                const assignedEngineer = eligibleEngineers[0];
                const assignedEngineerRef = doc(ENGINEER_COLLECTION, assignedEngineer.id);
                
                let resultText = '';

                await runTransaction(db, async (transaction) => {
                    
                    transaction.update(assignedEngineerRef, {
                        debt: increment(manualCost),
                        lastAssignedProject: clientName,
                    });
                    
                    const newProject = {
                        jobType: jobType,
                        cost: manualCost,
                        area: projectArea,
                        clientName: clientName,
                        organization: organization,
                        engineerId: assignedEngineer.id,
                        engineerName: assignedEngineer.name,
                        engineerRank: assignedEngineer.rank,
                        userId: ADMIN_UID, 
                        assignedAt: serverTimestamp(),
                    };
                    transaction.set(doc(PROJECTS_COLLECTION), newProject);

                    resultText = `Ú©Ø§Ø± Ø¨Ù‡ Ù…Ù‡Ù†Ø¯Ø³ ${assignedEngineer.name} (${assignedEngineer.rank}) Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø§Ø±Ø¬Ø§Ø¹ Ø´Ø¯. Ø¨Ø¯Ù‡ÙŠ Ø§ÙØ²Ø§ÙŠØ´ ÙŠØ§ÙØª Ø¨Ù‡ Ù…ÙŠØ²Ø§Ù† ${formatCost(manualCost)}.`;
                });

                const resultDiv = document.getElementById('assignmentResult');
                resultDiv.classList.remove('hidden', 'border-r-4', 'border-red-500');
                resultDiv.classList.add('border-r-4', 'border-green-500');
                document.getElementById('resultText').textContent = resultText;
                
                showMessage('Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.', 'success');
                document.getElementById('assignProjectForm').reset();
                renderDynamicInputs(null);
                
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø¬Ø§Ø¹ Ù¾Ø±ÙˆÚ˜Ù‡ (ØªØ±Ø§Ú©Ù†Ø´): ", error);
                showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø¬Ø§Ø¹ Ù¾Ø±ÙˆÚ˜Ù‡. Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ù…Ø´Ú©Ù„ Ø³Ù‡Ù…ÙŠÙ‡ØŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø³Øª.', 'error');
            }
        });
        
        
        // Reset Quota (Single Engineer)
        async function resetEngineerQuota(engineerId, engineerName) {
            // ğŸš¨ Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ: ÙÙ‚Ø· Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø§Ø´Ø¯
            if (!isAuthReady || !isCurrentUserAdmin()) {
                showMessage('Ø¯Ø³ØªØ±Ø³ÛŒ Ù„Ø§Ø²Ù… Ø¨Ø±Ø§ÛŒ ØªØ³ÙˆÛŒÙ‡ Ø¨Ø¯Ù‡ÛŒ Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ø¯Ù…ÛŒÙ† ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.', 'error');
                closeModal('confirmationModal');
                return;
            }
            
            const engineerRef = doc(ENGINEER_COLLECTION, engineerId);
            
            try {
                await updateDoc(engineerRef, {
                    debt: 0,
                    lastResetAt: serverTimestamp(),
                });
                showMessage(`Ø¨Ø¯Ù‡ÙŠ Ù…Ù‡Ù†Ø¯Ø³ ${engineerName} Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª ØªØ³ÙˆÙŠÙ‡ Ø´Ø¯.`, 'success');
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± ØªØ³ÙˆÙŠÙ‡ Ø³Ù‡Ù…ÙŠÙ‡: ", error);
                showMessage(`Ø®Ø·Ø§ Ø¯Ø± ØªØ³ÙˆÙŠÙ‡ Ø³Ù‡Ù…ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³ ${engineerName}.`, 'error');
            } finally {
                closeModal('confirmationModal');
            }
        }
        
        // Reset All Quotas
        async function resetAllQuotas() {
             // ğŸš¨ Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ: ÙÙ‚Ø· Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± ÙØ¹Ù„ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø§Ø´Ø¯
             if (!isAuthReady || !isCurrentUserAdmin()) {
                showMessage('Ø¯Ø³ØªØ±Ø³ÛŒ Ù„Ø§Ø²Ù… Ø¨Ø±Ø§ÛŒ ØªØ³ÙˆÛŒÙ‡ Ø¹Ù…ÙˆÙ…ÛŒ Ø¨Ø¯Ù‡ÛŒ Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ø¯Ù…ÛŒÙ† ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.', 'error');
                closeModal('confirmationModal');
                return;
            }
            
            closeModal('confirmationModal');
            showMessage('Ø¯Ø± Ø­Ø§Ù„ ØªØ³ÙˆÙŠÙ‡ Ø¨Ø¯Ù‡ÙŠ Ù‡Ù…Ù‡ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†...', 'info');

            try {
                const batch = writeBatch(db);
                let count = 0;
                
                for (const id in allEngineersMap) {
                    const eng = allEngineersMap[id];
                    if (eng.debt > 0) {
                         const engineerRef = doc(ENGINEER_COLLECTION, id);
                         batch.update(engineerRef, {
                             debt: 0,
                             lastResetAt: serverTimestamp(),
                         });
                         count++;
                    }
                }
                
                if (count > 0) {
                     await batch.commit();
                     showMessage(`${count} Ø¨Ø¯Ù‡ÙŠ Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª ØªØ³ÙˆÙŠÙ‡ Ùˆ Ø³Ù‡Ù…ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ø² Ø´Ø¯.`, 'success');
                } else {
                     showMessage('Ø¨Ø¯Ù‡ÙŠ Ø¨Ø±Ø§ÙŠ ØªØ³ÙˆÙŠÙ‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´Øª.', 'info');
                }
                
            } catch (error) {
                 console.error("Ø®Ø·Ø§ Ø¯Ø± ØªØ³ÙˆÙŠÙ‡ Ø¯Ø³ØªÙ‡â€ŒØ§ÙŠ Ø³Ù‡Ù…ÙŠÙ‡â€ŒÙ‡Ø§: ", error);
                 showMessage('Ø®Ø·Ø§ Ø¯Ø± ØªØ³ÙˆÙŠÙ‡ Ø¯Ø³ØªÙ‡â€ŒØ§ÙŠ. Ø¹Ù…Ù„ÙŠØ§Øª Ù„ØºÙˆ Ø´Ø¯.', 'error');
            }
        }
        
        // ====================================================================
        // === WINDOW EXPOSURE AND MODAL/REPORTING FUNCTIONS ===
        // ====================================================================

        window.showConfirmation = function(action, id = null, name = null) {
            // Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø±Ù†Ø¯Ø± Ù„ÛŒØ³Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³ØªØŒ Ø§Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ù… Ú©Ù†ØªØ±Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            if (!isCurrentUserAdmin() && (action === 'resetQuota' || action === 'resetAllQuotas')) {
                 showMessage('Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø§Ù‚Ø¯Ø§Ù… Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.', 'error');
                 return;
            }
            
            const confirmModalTitle = document.getElementById('confirmModalTitle');
            const confirmModalMessage = document.getElementById('confirmModalMessage');
            const confirmAcceptBtn = document.getElementById('confirmAcceptBtn');
            
            openModal('confirmationModal');
            
            if (action === 'resetQuota') {
                confirmModalTitle.textContent = `ØªØ³ÙˆÙŠÙ‡ Ø¨Ø¯Ù‡ÙŠ Ù…Ù‡Ù†Ø¯Ø³ ${name}`;
                confirmModalMessage.innerHTML = `Ø¢ÙŠØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÙŠØ¯ Ú©Ù‡ Ø¨Ø¯Ù‡ÙŠ Ù…Ù‡Ù†Ø¯Ø³ **${name}** (Ø¨Ø§ Ù…Ø¨Ù„Øº ${formatCost(allEngineersMap[id]?.debt || 0)}) ØªØ³ÙˆÙŠÙ‡ Ø´Ø¯Ù‡ Ùˆ Ø³Ù‡Ù…ÙŠÙ‡ Ø§Ùˆ ØµÙØ± Ø´ÙˆØ¯ØŸ`;
                confirmAcceptBtn.onclick = () => resetEngineerQuota(id, name);
                confirmAcceptBtn.textContent = 'ØªØ³ÙˆÙŠÙ‡ Ú©Ù†';
            } else if (action === 'resetAllQuotas') {
                confirmModalTitle.textContent = 'ØªØ³ÙˆÙŠÙ‡ Ø¯Ø³ØªÙ‡â€ŒØ§ÙŠ Ø³Ù‡Ù…ÙŠÙ‡â€ŒÙ‡Ø§';
                confirmModalMessage.textContent = 'Ø¢ÙŠØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÙŠØ¯ Ú©Ù‡ Ø¨Ø¯Ù‡ÙŠ ØªÙ…Ø§Ù… Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†ÛŒ Ú©Ù‡ Ø¨Ø¯Ù‡Ú©Ø§Ø± Ù‡Ø³ØªÙ†Ø¯ØŒ ØªØ³ÙˆÙŠÙ‡ Ø´Ø¯Ù‡ Ùˆ Ø³Ù‡Ù…ÙŠÙ‡ Ø¢Ù†â€ŒÙ‡Ø§ ØµÙØ± Ø´ÙˆØ¯ØŸ Ø§ÙŠÙ† Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø±Ú¯Ø´Øªâ€ŒÙ†Ø§Ù¾Ø°ÙŠØ± Ø§Ø³Øª.';
                confirmAcceptBtn.onclick = resetAllQuotas;
                confirmAcceptBtn.textContent = 'ØªØ£ÙŠÙŠØ¯ ØªØ³ÙˆÙŠÙ‡ Ø¹Ù…ÙˆÙ…ÙŠ';
            }
        }
        
        window.showEngineerProjects = async function(engineerId, engineerName) {
            openModal('detailsModal');
            modalTitleRef.textContent = `Ø¬Ø²Ø¦ÙŠØ§Øª Ú©Ø§Ø±Ù‡Ø§ÙŠ Ù…Ù‡Ù†Ø¯Ø³: ${engineerName}`;
            projectsListRef.innerHTML = '';
            modalLoadingMessageRef.classList.remove('hidden');

            try {
                const engineerProjects = allProjects
                    .filter(p => p.engineerId === engineerId)
                    .sort((a, b) => (b.assignedAt?.toMillis() || 0) - (a.assignedAt?.toMillis() || 0));

                modalLoadingMessageRef.classList.add('hidden');
                
                if (engineerProjects.length === 0) {
                    projectsListRef.innerHTML = '<p class="text-center text-gray-500 p-4">Ù‡ÙŠÚ† Ú©Ø§Ø±ÙŠ Ø¨Ø±Ø§ÙŠ Ø§ÙŠÙ† Ù…Ù‡Ù†Ø¯Ø³ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
                    return;
                }

                let projectsHtml = '';
                engineerProjects.forEach(p => {
                    const assignedDate = p.assignedAt ? new Date(p.assignedAt.toMillis()).toLocaleDateString('fa-IR') : 'Ù†Ø§Ù…Ø´Ø®Øµ';
                    const area = p.area ? `${p.area} Ù….Ù…` : '---';
                    
                    projectsHtml += `
                        <div class="p-3 border rounded-lg bg-gray-50 hover:bg-gray-100 transition">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-gray-800">${p.jobType}</span>
                                <span class="text-sm font-semibold text-blue-700">${formatCost(p.cost)}</span>
                            </div>
                            <p class="text-xs text-gray-600">
                                Ù…ØªÙ‚Ø§Ø¶ÙŠ: ${p.clientName} | 
                                Ø§Ø±Ú¯Ø§Ù†: ${p.organization} |
                                Ù…ØªØ±Ø§Ú˜: ${area} |
                                ØªØ§Ø±ÙŠØ®: ${assignedDate}
                            </p>
                        </div>
                    `;
                });
                
                projectsListRef.innerHTML = projectsHtml;

            } catch (error) {
                console.error("Error loading project details: ", error);
                modalLoadingMessageRef.classList.add('hidden');
                projectsListRef.innerHTML = '<p class="text-center text-red-500 p-4">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ø¬Ø²Ø¦ÙŠØ§Øª Ú©Ø§Ø±Ù‡Ø§.</p>';
            }
        }


        window.showMonthlyReport = function() {
            openModal('printReportModal');
            const reportArea = document.getElementById('printReportArea');
            reportArea.innerHTML = '<div class="text-center p-8 text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÙŠ Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡ÙŠØ§Ù†Ù‡...</div>';
            
            // 1. Calculate Aggregates
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59);

            const startTime = startOfMonth.getTime();
            const endTime = endOfMonth.getTime();

            const monthlyProjects = allProjects.filter(p => {
                const assignedTime = p.assignedAt ? p.assignedAt.toMillis() : 0;
                return assignedTime >= startTime && assignedTime <= endTime;
            });

            const engineerStats = {};
            let totalMonthlyProjects = 0;
            let totalMonthlyCost = 0;

            monthlyProjects.forEach(p => {
                totalMonthlyProjects++;
                totalMonthlyCost += p.cost;

                const engId = p.engineerId;
                if (!engineerStats[engId]) {
                    engineerStats[engId] = {
                        name: p.engineerName,
                        rank: p.engineerRank,
                        projectCount: 0,
                        totalCost: 0,
                    };
                }
                engineerStats[engId].projectCount++;
                engineerStats[engId].totalCost += p.cost;
            });

            // 2. Prepare Report HTML
            const reportTitleHtml = `
                <div class="print-only mb-6 text-center">
                    <h1 class="text-2xl font-bold text-gray-900 mb-1">Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø§Ù…Ø¹ Ø§Ø±Ø¬Ø§Ø¹Ø§Øª Ú©Ø§Ø± (Ù…Ø§Ù‡ÙŠØ§Ù†Ù‡)</h1>
                    <p class="text-base text-gray-600">Ø¯ÙˆØ±Ù‡ Ø²Ù…Ø§Ù†ÙŠ: ${startOfMonth.toLocaleDateString('fa-IR')} - ${endOfMonth.toLocaleDateString('fa-IR')}</p>
                    <p class="text-sm text-gray-500 mt-2">ØªØ§Ø±ÙŠØ® Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÙŠØ±ÙŠ: ${new Date().toLocaleDateString('fa-IR')} ${new Date().toLocaleTimeString('fa-IR')}</p>
                </div>
            `;
            
            let reportHtml = `
                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-3 text-blue-800 border-b pb-2">Ø®Ù„Ø§ØµÙ‡ Ú©Ù„ÙŠ</h3>
                    <div class="flex flex-wrap gap-4 text-center">
                        <div class="bg-blue-100 p-4 rounded-lg flex-1 min-w-[200px] border">
                            <p class="text-sm text-gray-600">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÙŠ Ù…Ø§Ù‡</p>
                            <p class="text-2xl font-bold text-blue-800">${totalMonthlyProjects}</p>
                        </div>
                        <div class="bg-green-100 p-4 rounded-lg flex-1 min-w-[200px] border">
                            <p class="text-sm text-gray-600">Ø§Ø±Ø²Ø´ Ø±ÙŠØ§Ù„ÙŠ Ú©Ù„ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§</p>
                            <p class="text-2xl font-bold text-green-800">${formatCost(totalMonthlyCost)}</p>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg flex-1 min-w-[200px] border">
                            <p class="text-sm text-gray-600">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† ÙØ¹Ø§Ù„</p>
                            <p class="text-2xl font-bold text-purple-800">${Object.keys(allEngineersMap).length}</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-3 text-blue-800 border-b pb-2">Ø¢Ù…Ø§Ø± Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ø¯Ø± Ù…Ø§Ù‡</h3>
                    <table class="report-table w-full text-right text-sm">
                        <thead>
                            <tr class="bg-blue-100 text-blue-800 font-bold">
                                <th class="p-2 border">Ø±Ø¯ÙŠÙ</th>
                                <th class="p-2 border">Ù†Ø§Ù… Ù…Ù‡Ù†Ø¯Ø³</th>
                                <th class="p-2 border">Ù¾Ø§ÙŠÙ‡</th>
                                <th class="p-2 border">ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡</th>
                                <th class="p-2 border">Ø§Ø±Ø²Ø´ Ø±ÙŠØ§Ù„ÙŠ Ø§Ø±Ø¬Ø§Ø¹ (Ù….Øª)</th>
                                <th class="p-2 border">Ø¨Ø¯Ù‡ÙŠ ÙØ¹Ù„ÙŠ (Ù….Øª)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let i = 1;
            const sortedStats = Object.values(engineerStats).sort((a, b) => b.totalCost - a.totalCost);
            
            if (sortedStats.length === 0 && Object.keys(allEngineersMap).length > 0) {
                reportHtml += `<tr><td colspan="6" class="text-center p-4 text-gray-500">Ø¯Ø± Ø§ÙŠÙ† Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÙŠØŒ Ù‡ÙŠÚ† Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÙŠ Ø¨Ù‡ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ø§Ø±Ø¬Ø§Ø¹ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td></tr>`;
            } else {
                sortedStats.forEach(stat => {
                    const currentDebt = allEngineersMap[Object.keys(allEngineersMap).find(key => allEngineersMap[key].name === stat.name)]?.debt || 0;
                    reportHtml += `
                        <tr class="hover:bg-gray-50">
                            <td class="p-2 border">${i++}</td>
                            <td class="p-2 border font-medium">${stat.name}</td>
                            <td class="p-2 border text-blue-600">${stat.rank}</td>
                            <td class="p-2 border text-center">${stat.projectCount}</td>
                            <td class="p-2 border font-mono">${formatCost(stat.totalCost)}</td>
                            <td class="p-2 border text-red-600">${formatCost(currentDebt)}</td>
                        </tr>
                    `;
                });
            }
            
            reportHtml += `
                        </tbody>
                        <tfoot>
                            <tr class="bg-gray-200 font-bold">
                                <td colspan="4" class="p-2 border text-left">Ø¬Ù…Ø¹ Ú©Ù„:</td>
                                <td class="p-2 border">${formatCost(totalMonthlyCost)}</td>
                                <td class="p-2 border">${formatCost(Object.values(allEngineersMap).reduce((sum, eng) => sum + eng.debt, 0))}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;

            currentReportData = { title: reportTitleHtml, content: reportHtml };
            reportArea.innerHTML = reportTitleHtml + reportHtml;
        }

        window.printReport = function() {
            if (!currentReportData) {
                showMessage('Ø§Ø¨ØªØ¯Ø§ Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡ÙŠØ§Ù†Ù‡ Ø±Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ú©Ù†ÙŠØ¯.', 'error');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write('<!DOCTYPE html><html><head><title>Ú¯Ø²Ø§Ø±Ø´ Ú†Ø§Ù¾ÙŠ</title>');
            
            printWindow.document.write(`
                <meta charset="UTF-8">
                <style>
                    body, html { margin: 20px; padding: 0; font-family: Tahoma, Arial, sans-serif; direction: rtl; }
                    .report-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    .report-table th, .report-table td { border: 1px solid #ccc; padding: 8px; text-align: right; font-size: 14px; }
                    .report-table thead th { background-color: #dbeafe; color: #1e3a8a; -webkit-print-color-adjust: exact; color-adjust: exact; }
                    .report-table tfoot td { background-color: #f3f4f6; font-weight: bold; -webkit-print-color-adjust: exact; color-adjust: exact; }
                    .print-only { display: block !important; }
                    .text-center { text-align: center; }
                    .mb-6 { margin-bottom: 1.5rem; }
                    .text-2xl { font-size: 1.5rem; }
                    .font-bold { font-weight: 700; }
                    .text-red-600 { color: #dc2626; } 
                    .text-blue-600 { color: #2563eb; }
                    .flex-wrap { display: flex; flex-wrap: wrap; gap: 1rem; }
                    .flex-1 { flex: 1; }
                    .p-4 { padding: 1rem; }
                    .rounded-lg { border-radius: 0.5rem; }
                    .bg-blue-100 { background-color: #dbeafe; }
                    .bg-green-100 { background-color: #d1fae5; }
                    .bg-purple-100 { background-color: #f3e8ff; }
                </style>
            `);

            printWindow.document.write('</head><body>');
            
            printWindow.document.write(currentReportData.title.replace('print-only', '')); 
            printWindow.document.write(currentReportData.content);

            printWindow.document.write('</body></html>');
            printWindow.document.close();
            
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };
        }
    </script>
</body>
</html>
ğŸ“Œ ØªØ£ÛŒÛŒØ¯ Ù†Ù‡Ø§ÛŒÛŒ Ú¯Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ
Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø§ÛŒÙ† Ú©Ø¯ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ù†Ù‚Øµ Ú©Ø§Ø± Ú©Ù†Ø¯ØŒ Ù„Ø·ÙØ§ ØªØ£ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯ Ú©Ù‡ Ø¯Ùˆ Ù…Ø±Ø­Ù„Ù‡ Ø²ÛŒØ± Ø±Ø§ Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„ Firebase Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯:

Û±. ğŸ” Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ù…Ù†ÛŒØªÛŒ Firestore
Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ú©Ù‡ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ù…Ù†ÛŒØªÛŒ Ø´Ù…Ø§ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø¨Ù‡ Ø´Ú©Ù„ Ø²ÛŒØ± Ø§Ø³Øª (Ø¨Ø§ UID Ø§Ø¯Ù…ÛŒÙ† ØµØ­ÛŒØ­ Ø´Ù…Ø§):

Code snippet

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAdmin() {
      // UID Ø´Ù…Ø§
      return request.auth != null && 
             request.auth.uid == 'rl8GBO00j7hZy4iwDnxaSRcKteL2'; 
    }

    // Ù‡Ø± Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ù†Ø§Ø´Ù†Ø§Ø³ ÛŒØ§ Ú¯ÙˆÚ¯Ù„) Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ø®ÙˆØ§Ù†Ø¯
    match /{document=**} {
      allow read: if request.auth != null;
    }

    // ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨Ù†ÙˆÛŒØ³Ø¯/Ø¢Ù¾Ø¯ÛŒØª Ú©Ù†Ø¯/Ø­Ø°Ù Ú©Ù†Ø¯
    match /engineers/{engineerId} {
      allow create, update, delete: if isAdmin();
    }

    match /projects/{projectId} {
      allow create, update, delete: if isAdmin();
    }
  }
}
