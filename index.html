<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø¯ÙŠØ±ÙŠØª Ø³Ù‡Ù…ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ù†Ù‚Ø´Ù‡ Ø¨Ø±Ø¯Ø§Ø±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ØªØ¹ÛŒÛŒÙ† ÙÙˆÙ†Øª Ø¨Ù‡ØªØ± Ø¨Ø±Ø§ÛŒ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ - Ø¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ Vazirmatn ÛŒØ§ IRANSans ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ */
        body {
            font-family: 'Inter', Tahoma, Arial, sans-serif; 
            background-color: #f7f9fb;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #0f3d6c 0%, #2563eb 100%);
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        .modal-container {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-container.active {
            opacity: 1;
            visibility: visible;
        }
        .view-container {
            min-height: 400px; 
        }
        .hidden-view {
            display: none;
        }
        
        /* Print Styles: Critical for clean printouts */
        @media print {
            .print\:hidden {
                display: none !important;
            }
            body, html {
                margin: 0;
                padding: 0;
                background: white;
                color: black;
            }
            #printReportModal {
                display: flex !important;
                position: static;
                background: white !important;
                height: auto;
                width: 100%;
                max-width: none;
            }
            #reportContentContainer {
                max-width: 100%;
                width: 100%;
                height: auto;
                box-shadow: none;
                padding: 0;
                border: none;
            }
            #printReportArea {
                overflow: visible !important;
                padding: 0;
            }
            .report-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
                border: 1px solid #ccc;
            }
            .report-table thead, .report-table tfoot {
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .report-table thead th {
                background-color: #dbeafe !important;
                color: #1e3a8a !important; 
            }
            .report-table tfoot td {
                background-color: #f3f4f6 !important;
                font-weight: bold;
            }
            .report-table th, .report-table td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: right;
                font-size: 14px; 
            }
            .print-only {
                display: block !important;
            }
            /* Ensure all text is black for printing */
            .text-gray-800, .text-blue-800, .text-green-700 {
                color: black !important;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="gradient-bg text-white p-6 rounded-xl mb-8 card print:hidden">
            <h1 class="text-3xl font-bold mb-2">Ø³Ø§Ù…Ø§Ù†Ù‡ Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ù†Ù‚Ø´Ù‡ Ø¨Ø±Ø¯Ø§Ø±</h1>
            <p class="text-sm opacity-90">Ù…Ø¯ÙŠØ±ÙŠØª Ø³Ù‡Ù…ÙŠÙ‡ Ø§Ø¹ØªØ¨Ø§Ø±ÙŠ Ùˆ Ø§Ø±Ø¬Ø§Ø¹ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾Ø§ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³ÙŠ Ùˆ Ù…Ø¯ÙŠØ±ÙŠØª Ø¨Ø¯Ù‡ÙŠ.</p>
        </header>

        <div id="messageBox" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg z-50 transition-all duration-300 shadow-xl w-full max-w-sm text-center" role="alert"></div>

        <div class="flex flex-wrap justify-center gap-4 mb-8 print:hidden">
            <button onclick="showView('addEngineerModal')"
                    class="bg-green-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-green-700 transition duration-150 transform hover:scale-105 min-w-[200px]">
                Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³ Ø¬Ø¯ÙŠØ¯
            </button>
            <button onclick="showView('assignProjectModal')"
                    class="bg-blue-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition duration-150 transform hover:scale-105 min-w-[200px]">
                Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ø¬Ø¯ÙŠØ¯
            </button>
            <button onclick="showView('dashboardView')"
                    class="bg-gray-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-gray-700 transition duration-150 transform hover:scale-105 min-w-[200px]">
                Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†
            </button>
            <button onclick="showMonthlyReport()"
                    class="bg-purple-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-purple-700 transition duration-150 transform hover:scale-105 min-w-[200px]">
                Ø¢Ù…Ø§Ø± Ù…Ø§Ù‡ÙŠØ§Ù†Ù‡
            </button>
        </div>

        <div id="contentArea" class="view-container">

            <div id="addEngineerModal" class="bg-white p-6 rounded-xl card hidden-view">
                <h3 class="text-2xl font-bold text-green-700 border-b pb-3 mb-4">Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³ Ø¬Ø¯ÙŠØ¯</h3>
                <form id="addEngineerForm" class="space-y-4 max-w-lg mx-auto">
                    <div>
                        <label for="engineerName" class="block text-sm font-medium text-gray-700 mb-1">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÙŠ Ù…Ù‡Ù†Ø¯Ø³:</label>
                        <input type="text" id="engineerName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯ÙŠ">
                    </div>
                    <div>
                        <label for="engineerRank" class="block text-sm font-medium text-gray-700 mb-1">Ù¾Ø§ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³ÙŠ:</label>
                        <select id="engineerRank" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                            <option value="" disabled selected>Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§ÙŠÙ‡...</option>
                            <option value="Ù¾Ø§ÙŠÙ‡ Ø³Ù‡">Ù¾Ø§ÙŠÙ‡ Ø³Ù‡</option>
                            <option value="Ù¾Ø§ÙŠÙ‡ Ø¯Ùˆ">Ù¾Ø§ÙŠÙ‡ Ø¯Ùˆ</option>
                            <option value="Ù¾Ø§ÙŠÙ‡ ÙŠÚ©">Ù¾Ø§ÙŠÙ‡ ÙŠÚ©</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition duration-150 shadow-md">Ø°Ø®ÙŠØ±Ù‡ Ù…Ù‡Ù†Ø¯Ø³</button>
                </form>
            </div>

            <div id="assignProjectModal" class="bg-white p-6 rounded-xl card hidden-view">
                <h3 class="text-2xl font-bold text-blue-800 border-b pb-3 mb-4">Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3>
                <form id="assignProjectForm" class="space-y-5 max-w-lg mx-auto">
                    <div>
                        <label for="jobType" class="block text-sm font-medium text-gray-700 mb-1">Ù†ÙˆØ¹ Ú©Ø§Ø± / Ù†Ù‚Ø´Ù‡:</label>
                        <select id="jobType" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="" disabled selected>Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ú©Ø§Ø±...</option>
                            </select>
                    </div>

                    <div id="dynamicInputs" class="space-y-4 p-4 border rounded-lg bg-gray-50">
                        <p class="text-sm text-gray-500 text-center">Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ú©Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÙŠØ¯ ØªØ§ Ø¬Ø²Ø¦ÙŠØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ø´Ø®Øµ Ø´ÙˆØ¯.</p>
                    </div>
                    
                    <div>
                        <label for="clientName" class="block text-sm font-medium text-gray-700 mb-1">Ù†Ø§Ù… Ù…ØªÙ‚Ø§Ø¶ÙŠ ØªÙ‡ÙŠÙ‡ Ù†Ù‚Ø´Ù‡:</label>
                        <input type="text" id="clientName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø´Ø±Ú©Øª ØªÙˆØ³Ø¹Ù‡ Ø´Ù‡Ø±">
                    </div>

                    <div id="assignmentResult" class="p-4 border-r-4 rounded-lg text-gray-800 hidden">
                        <h3 class="font-bold text-lg mb-2">Ù†ØªÙŠØ¬Ù‡ Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø±:</h3>
                        <p id="resultText" class="text-blue-700 font-semibold"></p>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition duration-150 shadow-md">Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ùˆ Ù…Ø¹Ø±ÙÙŠ Ù…Ù‡Ù†Ø¯Ø³</button>
                </form>
            </div>

            <div id="dashboardView" class="bg-white p-6 rounded-xl card hidden-view">
                <h2 class="text-2xl font-semibold border-b pb-3 mb-4 text-gray-800">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³Ù‡Ù…ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† (Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù†)</h2>

                <div class="text-center p-4 text-gray-500" id="loadingMessage">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†...</div>
                
                <div id="engineerList" class="space-y-4">
                </div>

                <div id="newQuotaButtonContainer" class="mt-8 pt-4 border-t flex justify-center hidden">
                    <button onclick="showConfirmation('resetAllQuotas')" class="bg-red-700 text-white p-3 text-lg rounded-lg hover:bg-red-800 transition duration-150 shadow-2xl flex items-center font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v2M2 12A10 10 0 0 1 12 2a10 10 0 0 1 10 10M8 12l4 4 4-4" /></svg>
                        Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø³Ù‡Ù…ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯ Ø¨Ø±Ø§ÙŠ Ù‡Ù…Ù‡ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† (ØªØ³ÙˆÙŠÙ‡ Ø¨Ø¯Ù‡ÙŠ)
                    </button>
                </div>
                
            </div>

        </div> 
    </div>

    <div id="detailsModal" class="modal-container fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl card max-w-2xl w-full p-6" role="dialog" aria-modal="true">
            <div class="flex justify-between items-start border-b pb-3 mb-4">
                <h3 id="modalTitle" class="text-xl md:text-2xl font-bold text-blue-800">Ø¬Ø²Ø¦ÙŠØ§Øª Ú©Ø§Ø±Ù‡Ø§</h3>
                <button onclick="closeModal('detailsModal')" class="text-gray-400 hover:text-gray-600 p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <div id="projectsList" class="max-h-96 overflow-y-auto space-y-3">
                <div class="text-center p-4 text-gray-500" id="modalLoadingMessage">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ø¬Ø²Ø¦ÙŠØ§Øª Ú©Ø§Ø±Ù‡Ø§...</div>
            </div>

            <div class="mt-6 border-t pt-4 text-left">
                <button onclick="closeModal('detailsModal')" class="bg-blue-600 text-white p-2 px-4 rounded-lg hover:bg-blue-700 transition">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
    </div>

    <div id="printReportModal" class="modal-container fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div id="reportContentContainer" class="bg-white rounded-xl card max-w-6xl w-full p-6 h-[90vh] flex flex-col" role="dialog" aria-modal="true">
            <div class="flex justify-between items-start border-b pb-3 mb-4 flex-shrink-0 print:hidden">
                <h3 class="text-2xl font-bold text-gray-800">Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø§Ù…Ø¹ Ù…Ø§Ù‡ÙŠØ§Ù†Ù‡ Ø§Ø±Ø¬Ø§Ø¹Ø§Øª Ú©Ø§Ø±</h3>
                <button onclick="closeModal('printReportModal')" class="text-gray-400 hover:text-gray-600 p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <div id="printReportArea" class="flex-grow overflow-y-auto p-2">
                <div class="text-center p-8 text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÙŠ Ú¯Ø²Ø§Ø±Ø´...</div>
            </div>

            <div class="mt-4 border-t pt-4 flex justify-end gap-3 flex-shrink-0 footer-buttons print:hidden">
                <button onclick="window.printReport()" class="bg-green-600 text-white p-2 px-4 rounded-lg hover:bg-green-700 transition flex items-center font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H3v6h2v3h10v-3h2V7h-2V4h-3V3H8v1H5zm0 1h2v2H5V5zm10 0v2h-2V5h2zM5 14v-2h10v2H5zm10 2v-2h-2v2h2zM5 16h2v-2H5v2z" clip-rule="evenodd"/></svg>
                    Ú†Ø§Ù¾ Ú¯Ø²Ø§Ø±Ø´
                </button>
                <button onclick="closeModal('printReportModal')" class="bg-gray-500 text-white p-2 px-4 rounded-lg hover:bg-gray-600 transition">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
    </div>
    
    <div id="confirmationModal" class="modal-container fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl card max-w-sm w-full p-6" role="alertdialog" aria-modal="true">
            <h3 id="confirmModalTitle" class="text-xl font-bold text-red-700 border-b pb-2 mb-4">ØªØ§ÙŠÙŠØ¯ Ø¹Ù…Ù„ÙŠØ§Øª</h3>
            <p id="confirmModalMessage" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="confirmCancelBtn" onclick="closeModal('confirmationModal')" class="bg-gray-300 text-gray-800 p-2 px-4 rounded-lg hover:bg-gray-400 transition">Ø§Ù†ØµØ±Ø§Ù</button>
                <button id="confirmAcceptBtn" class="bg-red-600 text-white p-2 px-4 rounded-lg hover:bg-red-700 transition">ØªØ§ÙŠÙŠØ¯ Ùˆ Ø§Ø¬Ø±Ø§</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // ğŸš¨ ØªØºÛŒÛŒØ± Ø§ØµÙ„ÛŒ: Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ signInAnonymously Ø¨Ø§ signInWithEmailAndPassword
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, runTransaction, query, where, getDocs, increment, writeBatch, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // âš ï¸ Ù…Ù‡Ù…: Ø§ÛŒÙ† Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¨Ø§ Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø®ÙˆØ¯ Ø¯Ø± Firebase Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯!
        const ADMIN_EMAIL = "admin@example.com"; 
        const ADMIN_PASSWORD = "YourSecurePassword"; 

        // CONFIG OBJECT
        const firebaseConfig = { 
            apiKey: "AIzaSyChV9mCptF4qybDn_yaOhmSz-KI3LhtDEQ",
            authDomain: "database-erjakar.firebaseapp.com",
            projectId: "database-erjakar",
            storageBucket: "database-erjakar.firebasestorage.app",
            messagingSenderId: "1056379437698",
            appId: "1:1056379437698:web:2a6bffc8ea0f1949436a9b",
            measurementId: "G-NS5ZPEFXD8"
        };
        
        // ØªÙ†Ø¸ÙŠÙ…Ø§Øª Ø³Ø±Ø§Ø³Ø±ÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³
        let app, db, auth, userId = null;
        let isAuthReady = false;
        
        // --- Static Data ---

        // Ù…Ø¨Ø§Ù„Øº Ù¾Ø§ÙŠÙ‡ Ù¾ÙŠØ´â€ŒÙØ±Ø¶ Ø¨Ø±Ø§ÙŠ Ø§Ù†ÙˆØ§Ø¹ Ú©Ø§Ø± (Ø¨Ù‡ ÙˆØ§Ø­Ø¯ Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù†)
        const PROJECT_COSTS = {
            'Ù†Ù‚Ø´Ù‡ Ú©Ø±ÙˆÚ©ÙŠ': 1,
            'Ù†Ù‚Ø´Ù‡ ØªÚ© Ø®Ø·ÙŠ': 2,
            'Ù†Ù‚Ø´Ù‡ ÙŠÙˆ ØªÙŠ Ø§Ù…': 4, 
        };
        
        // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ Ø¨Ø±Ø§ÙŠ Ù…Ø¯ÙŠØ±ÙŠØª ÙÙŠÙ„Ø¯Ù‡Ø§ÙŠ Ù…ØªØºÙŠØ±
        const JOB_DETAILS = {
            'Ù†Ù‚Ø´Ù‡ Ú©Ø±ÙˆÚ©ÙŠ': { label: 'Ù…ØªØ±Ø§Ú˜ Ø²Ù…ÙŠÙ† (Ù…ØªØ± Ù…Ø±Ø¨Ø¹):', isAreaRequired: true, organization: 'Ø´Ù‡Ø±Ø¯Ø§Ø±ÙŠ' },
            'Ù†Ù‚Ø´Ù‡ ØªÚ© Ø®Ø·ÙŠ': { label: 'Ù…ØªØ±Ø§Ú˜ Ú©Ù„ Ø²ÙŠØ± Ø¨Ù†Ø§ (Ù…ØªØ± Ù…Ø±Ø¨Ø¹):', isAreaRequired: true, organization: 'Ø´Ù‡Ø±Ø¯Ø§Ø±ÙŠ' },
            'Ù†Ù‚Ø´Ù‡ ÙŠÙˆ ØªÙŠ Ø§Ù…': { label: 'Ù…ØªØ±Ø§Ú˜ Ø²Ù…ÙŠÙ† (Ù…ØªØ± Ù…Ø±Ø¨Ø¹):', isAreaRequired: true, organization: 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†' }, 
        };

        // Ø³Ù‚Ù Ø³Ù‡Ù…ÙŠÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾Ø§ÙŠÙ‡ (Ø¨Ù‡ ÙˆØ§Ø­Ø¯ Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù†)
        const RANK_QUOTAS = {
            'Ù¾Ø§ÙŠÙ‡ Ø³Ù‡': 10,
            'Ù¾Ø§ÙŠÙ‡ Ø¯Ùˆ': 15,
            'Ù¾Ø§ÙŠÙ‡ ÙŠÚ©': 20,
        };
        
        // Ø§ÙˆÙ„ÙˆÙŠØª Ø¹Ø¯Ø¯ÙŠ Ù¾Ø§ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³ÙŠ Ø¨Ø±Ø§ÙŠ Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÙŠ (Ø¨ÙŠØ´ØªØ± = Ø§ÙˆÙ„ÙˆÙŠØª Ø¨Ø§Ù„Ø§ØªØ±)
        const RANK_PRIORITY = {
            'Ù¾Ø§ÙŠÙ‡ ÙŠÚ©': 3,
            'Ù¾Ø§ÙŠÙ‡ Ø¯Ùˆ': 2,
            'Ù¾Ø§ÙŠÙ‡ Ø³Ù‡': 1,
        };

        // Ø§Ø±Ú¯Ø§Ù†â€ŒÙ‡Ø§ÙŠ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø¨Ø±Ø§ÙŠ Ù†Ù‚Ø´Ù‡â€ŒÙ‡Ø§ÙŠ UTM
        const UTM_ORGANIZATIONS = [
            'Ø§ÙˆÙ‚Ø§Ù Ùˆ Ø§Ù…ÙˆØ±Ø®ÙŠØ±ÙŠÙ‡',
            'Ø¨Ù†ÙŠØ§Ø¯ Ù…Ø³Ú©Ù†',
            'Ø¬Ù‡Ø§Ø¯ Ú©Ø´Ø§ÙˆØ±Ø²ÙŠ',
            'Ù…Ù†Ø§Ø¨Ø¹ Ø·Ø¨ÙŠØ¹ÙŠ',
            'Ø§Ø¯Ø§Ø±Ù‡ Ø«Ø¨Øª Ø§Ø³Ù†Ø§Ø¯ Ùˆ Ø§Ù…Ù„Ø§Ú©',
            'Ù…ÙŠØ±Ø§Ø« ÙØ±Ù‡Ù†Ú¯ÙŠ',
            'Ø´Ù‡Ø±Ø¯Ø§Ø±ÙŠ' 
        ];
        
        // Ù…Ø³ÙŠØ±Ù‡Ø§ÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³
        let ENGINEER_COLLECTION, PROJECTS_COLLECTION;
        let allEngineersMap = {}; // Cache for engineer details
        let allProjects = []; // Cache for all projects (used in reporting)

        // Ù…Ø±Ø¬Ø¹ Ø¹Ù†Ø§ØµØ± Modal
        let detailsModalRef, modalTitleRef, projectsListRef, modalLoadingMessageRef;
        
        
        // ====================================================================
        // === UTILITY FUNCTIONS (ØªÙˆØ§Ø¨Ø¹ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ) ===
        // ====================================================================

        /**
         * ÙØ±Ù…Øªâ€ŒØ¯Ù‡ÙŠ Ù‡Ø²ÙŠÙ†Ù‡ Ø¨Ù‡ ØµÙˆØ±Øª Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù†
         * @param {number} cost - Ù…Ø¨Ù„Øº Ø¨Ù‡ Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù†
         * @returns {string} - Ø±Ø´ØªÙ‡ ÙØ±Ù…Øª Ø´Ø¯Ù‡
         */
        function formatCost(cost) {
            if (typeof cost !== 'number' || isNaN(cost)) return '0';
            return new Intl.NumberFormat('fa-IR').format(cost.toFixed(2)) + ' Ù….Øª';
        }

        /**
         * Ù†Ù…Ø§ÙŠØ´ Ù¾ÙŠØºØ§Ù… Ú©Ø§Ø±Ø¨Ø±Ø¯ÙŠ Ø¯Ø± ÙŠÚ© Ø¬Ø¹Ø¨Ù‡ Ù…ÙˆÙ‚Øª
         * @param {string} message 
         * @param {'success'|'error'|'info'} type 
         */
        function showMessage(message, type) {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg z-50 transition-all duration-300 shadow-xl w-full max-w-sm text-center';

            switch (type) {
                case 'success':
                    box.classList.add('bg-green-500', 'text-white');
                    break;
                case 'error':
                    box.classList.add('bg-red-500', 'text-white');
                    break;
                case 'info':
                    box.classList.add('bg-blue-500', 'text-white');
                    break;
            }

            box.classList.remove('hidden');

            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        }

        /**
         * Ø³ÙˆØ¦ÙŠÚ† Ø¨ÙŠÙ† Ù†Ù…Ø§Ù‡Ø§ÙŠ Ø§ØµÙ„ÙŠ Ø¨Ø±Ù†Ø§Ù…Ù‡
         * @param {string} viewId - Ø´Ù†Ø§Ø³Ù‡ Ù†Ù…Ø§ÙŠ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ('dashboardView', 'addEngineerModal', 'assignProjectModal')
         */
        function showView(viewId) {
            document.querySelectorAll('.view-container > div').forEach(view => {
                view.classList.add('hidden-view');
            });
            document.getElementById(viewId).classList.remove('hidden-view');
            
            // Ø§Ú¯Ø± Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ø¨Ø§Ø² Ø´Ø¯ØŒ ÙˆØ±ÙˆØ¯ÙŠâ€ŒÙ‡Ø§ÙŠ Ù¾ÙˆÙŠØ§ Ø¨Ø§Ø²Ø³Ø§Ø²ÙŠ Ø´ÙˆÙ†Ø¯
            if (viewId === 'assignProjectModal') {
                renderDynamicInputs(document.getElementById('jobType').value);
            }

            // Ø§Ø·Ù…ÙŠÙ†Ø§Ù† Ø§Ø² Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† ModalÙ‡Ø§
            closeModal('detailsModal');
            closeModal('printReportModal');
            closeModal('confirmationModal');
        }
        
        /**
         * Ø¨Ø§Ø² Ùˆ Ø¨Ø³ØªÙ‡ Ú©Ø±Ø¯Ù† ModalÙ‡Ø§
         * @param {string} modalId - Ø´Ù†Ø§Ø³Ù‡ Modal
         * @param {boolean} open - Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙŠØ§ Ø¨Ø³ØªÙ†
         */
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        function openModal(modalId) {
             const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
        }
        
        // ====================================================================
        // === DYNAMIC INPUTS & COST CALCULATION ===
        // ====================================================================

        /**
         * Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù‡Ø²ÙŠÙ†Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ùˆ Ù…ØªØ±Ø§Ú˜ (Ù…Ø«Ø§Ù„ÙŠ)
         * @param {string} jobType 
         * @param {number} area 
         * @returns {number} cost in million Toman
         */
        function calculateDynamicCost(jobType, area) {
            const baseCost = PROJECT_COSTS[jobType] || 0;
            // ÙØ±Ø¶: 10 Ø¯Ø±ØµØ¯ Ù‡Ø²ÙŠÙ†Ù‡ Ø«Ø§Ø¨Øª + 90 Ø¯Ø±ØµØ¯ Ù…ØªØºÙŠØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ØªØ±Ø§Ú˜
            // Ø¨Ø±Ø§ÙŠ Ø³Ø§Ø¯Ú¯ÙŠØŒ Ø§Ø² Ù‚ÙŠÙ…Øª Ø«Ø§Ø¨Øª Ø¯Ø± PROJECT_COSTS Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÙŠâ€ŒØ´ÙˆØ¯ Ùˆ Ø¢Ù† Ø±Ø§ ØªØ§ Ø­Ø¯ÙˆØ¯ÙŠ ØªØºÙŠÙŠØ± Ù…ÙŠâ€ŒØ¯Ù‡ÙŠÙ…
            
            let finalCost = baseCost;

            if (jobType === 'Ù†Ù‚Ø´Ù‡ Ú©Ø±ÙˆÚ©ÙŠ' && area > 0) {
                 finalCost = baseCost + (area * 0.005); // Ù…Ø«Ø§Ù„
            } else if (jobType === 'Ù†Ù‚Ø´Ù‡ ØªÚ© Ø®Ø·ÙŠ' && area > 0) {
                 finalCost = baseCost + (area * 0.007); // Ù…Ø«Ø§Ù„
            } else if (jobType === 'Ù†Ù‚Ø´Ù‡ ÙŠÙˆ ØªÙŠ Ø§Ù…' && area > 0) {
                 finalCost = baseCost + (area * 0.01); // Ù…Ø«Ø§Ù„
            }
            
            // Ú¯Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ù†Ø²Ø¯ÙŠÚ©â€ŒØªØ±ÙŠÙ† Û°.Û± Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù†
            return Math.ceil(finalCost * 10) / 10;
        }


        /**
         * Ø±Ù†Ø¯Ø± ÙÙŠÙ„Ø¯Ù‡Ø§ÙŠ ÙˆØ±ÙˆØ¯ÙŠ Ù¾ÙˆÙŠØ§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ú©Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
         * @param {string} jobType 
         */
        function renderDynamicInputs(jobType) {
            const container = document.getElementById('dynamicInputs');
            container.innerHTML = ''; // Clear previous content

            if (!jobType) {
                 container.innerHTML = '<p class="text-sm text-gray-500 text-center">Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ Ú©Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÙŠØ¯ ØªØ§ Ø¬Ø²Ø¦ÙŠØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ù…Ø´Ø®Øµ Ø´ÙˆØ¯.</p>';
                 return;
            }

            const details = JOB_DETAILS[jobType];
            
            // Area Input (if required)
            if (details.isAreaRequired) {
                 const areaInput = `
                     <div>
                         <label for="projectArea" class="block text-sm font-medium text-gray-700 mb-1">${details.label}</label>
                         <input type="number" step="1" min="1" id="projectArea" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ù…Ø«Ù„Ø§Ù‹: 120">
                     </div>
                   `;
                 container.innerHTML += areaInput;
            }

            // Organization Input (if 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†' is specified)
            let selectedOrganization = details.organization;

            if (details.organization === 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†') {
                 const orgSelect = document.createElement('select');
                 orgSelect.id = 'relatedOrganization';
                 orgSelect.required = true;
                 orgSelect.className = 'w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500';
                 
                 const defaultOption = document.createElement('option');
                 defaultOption.value = '';
                 defaultOption.textContent = 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù† Ù…Ø±Ø¨ÙˆØ·Ù‡...';
                 defaultOption.disabled = true;
                 defaultOption.selected = true;
                 orgSelect.appendChild(defaultOption);

                 UTM_ORGANIZATIONS.forEach(org => {
                     const option = document.createElement('option');
                     option.value = org;
                     option.textContent = org;
                     orgSelect.appendChild(option);
                 });
                 
                 const orgDiv = document.createElement('div');
                 orgDiv.innerHTML = '<label for="relatedOrganization" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø±Ú¯Ø§Ù† Ù…ØªÙ‚Ø§Ø¶ÙŠ Ù†Ù‚Ø´Ù‡ UTM:</label>';
                 orgDiv.appendChild(orgSelect);
                 container.appendChild(orgDiv);
                 selectedOrganization = orgSelect.value; // Get default/selected value
            }
            
            // Manual Cost Input (Always show for final confirmation)
            const initialCost = PROJECT_COSTS[jobType] || 0;
            const costInput = `
                <div>
                    <label for="manualCost" class="block text-sm font-medium text-gray-700 mb-1">Ù‡Ø²ÙŠÙ†Ù‡ Ù†Ù‡Ø§ÙŠÙŠ (Ù…ÙŠÙ„ÙŠÙˆÙ† ØªÙˆÙ…Ø§Ù† - Ù‚Ø§Ø¨Ù„ ÙˆÙŠØ±Ø§ÙŠØ´):</label>
                    <input type="number" step="0.1" min="0.1" id="manualCost" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="${initialCost.toFixed(1)}">
                </div>
                <div id="calculatedCostInfo" class="text-xs text-gray-500 p-2 border-t mt-2">
                    <span class="font-bold">Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡:</span> ${selectedOrganization}
                </div>
            `;
            container.innerHTML += costInput;

            // Add event listeners for dynamic calculation
            const projectAreaEl = document.getElementById('projectArea');
            const manualCostEl = document.getElementById('manualCost');

            const updateCost = () => {
                const area = projectAreaEl ? parseFloat(projectAreaEl.value) : 0;
                let calculated = calculateDynamicCost(jobType, area);
                
                // Update manual cost if area changes
                if (manualCostEl) {
                    manualCostEl.value = calculated.toFixed(1);
                }
            }

            if (projectAreaEl) {
                projectAreaEl.addEventListener('input', updateCost);
                // Call once to set initial calculated value if area is set
                if (projectAreaEl.value) updateCost();
            }
            
            // Update organization in info box if UTM is selected
            if (document.getElementById('relatedOrganization')) {
                document.getElementById('relatedOrganization').addEventListener('change', (e) => {
                    document.getElementById('calculatedCostInfo').innerHTML = `<span class="font-bold">Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡:</span> ${e.target.value}`;
                });
            }
        }
        
        // Add listener for job type change
        document.getElementById('jobType').addEventListener('change', (e) => {
            renderDynamicInputs(e.target.value);
        });
        
        // ====================================================================
        // === CORE FIREBASE INITIALIZATION & AUTHENTICATION (Ø¨Ø®Ø´ Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡) ===
        // ====================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // Populate Job Type dropdown on load
            const jobTypeSelect = document.getElementById('jobType');
            Object.keys(PROJECT_COSTS).forEach(jobType => {
                const option = document.createElement('option');
                option.value = jobType;
                option.textContent = jobType;
                jobTypeSelect.appendChild(option);
            });
            
            // Initial element references
            detailsModalRef = document.getElementById('detailsModal');
            modalTitleRef = document.getElementById('modalTitle');
            projectsListRef = document.getElementById('projectsList');
            modalLoadingMessageRef = document.getElementById('modalLoadingMessage');
            
            // Start Firebase setup
            initializeFirebase();
        });


        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // --- Start Authentication ---
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        showMessage(`Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÙŠØª Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. UID: ${userId.substring(0, 8)}...`, 'success');
                        
                        // ØªØ¹Ø±ÙŠÙ Ù…Ø±Ø§Ø¬Ø¹ Ú©Ø§Ù„Ú©Ø´Ù†â€ŒÙ‡Ø§ Ù¾Ø³ Ø§Ø² Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø¨ÙˆØ¯Ù† UID
                        ENGINEER_COLLECTION = collection(db, 'engineers');
                        PROJECTS_COLLECTION = collection(db, 'projects');

                        // Ø´Ø±ÙˆØ¹ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ú©Ø§Ù„Ú©Ø´Ù†â€ŒÙ‡Ø§ (Ø®ÙˆØ§Ù†Ø¯Ù†)
                        startRealtimeListeners();
                        
                        // Ù†Ù…Ø§ÙŠØ´ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ù‡ ØµÙˆØ±Øª Ù¾ÙŠØ´â€ŒÙØ±Ø¶
                        showView('dashboardView');
                        
                    } else {
                        // ğŸš¨ ØªØºÛŒÛŒØ±: ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø¯Ù…ÛŒÙ†
                        showMessage('Ø¯Ø± Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¯Ù…ÛŒÙ†...', 'info');
                        signInWithEmailAndPassword(auth, ADMIN_EMAIL, ADMIN_PASSWORD) // ğŸ‘ˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…ØªØ¯ ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†
                            .then(() => {
                                // ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ØŒ onAuthStateChanged Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØµØ¯Ø§ Ø²Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                            })
                            .catch((error) => {
                                console.error("Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†:", error);
                                // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§ÛŒ Ø¯Ù‚ÛŒÙ‚ Ø¨Ø±Ø§ÛŒ Ø§Ø´Ú©Ø§Ù„â€ŒØ²Ø¯Ø§ÛŒÛŒ
                                showMessage(`Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†: ${error.code} - ${error.message}`, 'error');
                            });
                    }
                });

            } catch (e) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³:", e);
                showMessage('Ø®Ø·Ø§: Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯.', 'error');
            }
        }
        
        // ====================================================================
        // === REALTIME LISTENERS & RENDERING ===
        // ====================================================================

        function startRealtimeListeners() {
            if (!isAuthReady || !userId) return;

            // 1. Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ú©Ø§Ù„Ú©Ø´Ù† Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†
            // ğŸš¨ ØªÙˆØ¬Ù‡: Ø§ÛŒÙ† Ú©ÙˆØ¦Ø±ÛŒ ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø´Ù…Ø§ Ø¯Ø± Ù‚ÙˆØ§Ù†ÛŒÙ† ÙØ§ÛŒØ±Ø¨ÛŒØ³ (Security Rules) Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ UID ØªØ¹Ø±ÛŒÙ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.
            const engineersQuery = query(ENGINEER_COLLECTION, where("userId", "==", userId));

            onSnapshot(engineersQuery, (querySnapshot) => {
                const engineers = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allEngineersMap[doc.id] = { id: doc.id, ...data };
                    engineers.push({ id: doc.id, ...data });
                });
                renderEngineers(engineers);
            }, (error) => {
                console.error("Error listening to engineers collection: ", error);
                showMessage("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ù„ÙŠØ³Øª Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†: " + error.message, 'error');
            });
            
            // 2. Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ú©Ø§Ù„Ú©Ø´Ù† Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ (ÙÙ‚Ø· Ø¨Ø±Ø§ÙŠ Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÙŠØ±ÙŠ)
            const projectsQuery = query(PROJECTS_COLLECTION, where("userId", "==", userId));

            onSnapshot(projectsQuery, (querySnapshot) => {
                allProjects = []; // Clear old cache
                querySnapshot.forEach((doc) => {
                    allProjects.push({ id: doc.id, ...doc.data() });
                });
                // Note: The report view is only rendered when explicitly requested (showMonthlyReport)
            }, (error) => {
                console.error("Error listening to projects collection: ", error);
                showMessage("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ù„ÙŠØ³Øª Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§: " + error.message, 'error');
            });
        }


        /**
         * Ø±Ù†Ø¯Ø± Ù„ÙŠØ³Øª Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ø¯Ø± Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
         * @param {Array<Object>} engineers 
         */
        function renderEngineers(engineers) {
            const listContainer = document.getElementById('engineerList');
            const loadingMessage = document.getElementById('loadingMessage');
            const quotaBtnContainer = document.getElementById('newQuotaButtonContainer');

            loadingMessage.classList.add('hidden');
            
            if (engineers.length === 0) {
                 listContainer.innerHTML = '<p class="text-center text-xl text-gray-500 p-8">âš ï¸ Ù‡ÙŠÚ† Ù…Ù‡Ù†Ø¯Ø³ÙŠ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
                 quotaBtnContainer.classList.add('hidden');
                 return;
            }

            // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÙŠ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾Ø§ÙŠÙ‡ (Ø¨Ø§Ù„Ø§ØªØ± Ø§ÙˆÙ„) Ø³Ù¾Ø³ Ø¨Ø¯Ù‡ÙŠ (Ø¨ÙŠØ´ØªØ± Ø§ÙˆÙ„)
            engineers.sort((a, b) => {
                const rankA = RANK_PRIORITY[a.rank] || 0;
                const rankB = RANK_PRIORITY[b.rank] || 0;
                if (rankA !== rankB) {
                    return rankB - rankA; // Ù¾Ø§ÙŠÙ‡ Ø¨Ø§Ù„Ø§ØªØ± Ø§ÙˆÙ„
                }
                return b.debt - a.debt; // Ø¨Ø¯Ù‡ÙŠ Ø¨ÙŠØ´ØªØ± Ø§ÙˆÙ„
            });
            
            let html = '';
            let allDebtsSettled = true;

            engineers.forEach(eng => {
                const quotaMax = RANK_QUOTAS[eng.rank] || 0;
                const remainingQuota = Math.max(0, quotaMax - eng.debt);
                const debtPercent = quotaMax > 0 ? (eng.debt / quotaMax) * 100 : 0;
                const isOverQuota = eng.debt > quotaMax;
                
                if (eng.debt > 0) {
                    allDebtsSettled = false;
                }

                html += `
                    <div class="p-4 bg-white rounded-lg card flex items-center justify-between transition duration-150 hover:shadow-lg border ${isOverQuota ? 'border-red-500' : 'border-blue-200'}">
                        <div class="flex-1 min-w-0">
                            <h4 class="text-lg font-bold text-gray-800 truncate">${eng.name}</h4>
                            <p class="text-sm text-blue-600 font-semibold">${eng.rank}</p>
                            <p class="text-xs text-gray-500 mt-1">Ø¢Ø®Ø±ÙŠÙ† Ø§Ø±Ø¬Ø§Ø¹: ${eng.lastAssignedProject || 'Ù†Ø¯Ø§Ø±Ø¯'}</p>
                        </div>

                        <div class="w-2/5 mx-4">
                            <div class="text-xs font-semibold flex justify-between mb-1">
                                <span class="${isOverQuota ? 'text-red-600' : 'text-gray-800'}">Ø¨Ø¯Ù‡ÙŠ: ${formatCost(eng.debt)}</span>
                                <span class="text-gray-600">Ø³Ù‡Ù…ÙŠÙ‡: ${formatCost(quotaMax)}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="progress-bar-fill h-2.5 rounded-full ${isOverQuota ? 'bg-red-500' : 'bg-blue-500'}" style="width: ${Math.min(100, debtPercent)}%"></div>
                            </div>
                        </div>

                        <div class="text-right">
                            <p class="text-sm font-semibold ${isOverQuota ? 'text-red-700' : 'text-green-700'}">Ø¨Ø§Ù‚ÙŠÙ…Ø§Ù†Ø¯Ù‡:</p>
                            <p class="text-base font-bold ${isOverQuota ? 'text-red-700' : 'text-green-700'}">${formatCost(remainingQuota)}</p>
                        </div>
                        
                        <div class="ml-4 flex gap-2">
                            <button onclick="showEngineerProjects('${eng.id}', '${eng.name}')" 
                                class="bg-blue-500 text-white p-2 text-sm rounded-lg hover:bg-blue-600 transition shadow-md whitespace-nowrap">
                                Ø¬Ø²Ø¦ÙŠØ§Øª Ú©Ø§Ø±Ù‡Ø§
                            </button>
                            <button onclick="showConfirmation('resetQuota', '${eng.id}', '${eng.name}')" 
                                class="bg-red-500 text-white p-2 text-sm rounded-lg hover:bg-red-600 transition shadow-md">
                                ØªØ³ÙˆÙŠÙ‡
                            </button>
                        </div>
                    </div>
                `;
            });

            listContainer.innerHTML = html;
            
            // Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø³Ù‡Ù…ÛŒÙ‡ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø¯Ù‡ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡ÛŒØ¯
            if (!allDebtsSettled) {
                quotaBtnContainer.classList.remove('hidden');
            } else {
                quotaBtnContainer.classList.add('hidden');
            }
        }
        
        // ====================================================================
        // === CORE LOGIC (ADD/ASSIGN/RESET) ===
        // ====================================================================

        // Engineer Submission
        document.getElementById('addEngineerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAuthReady) {
                showMessage('Ù„Ø·ÙØ§Ù‹ Ù…Ù†ØªØ¸Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÙŠØª Ø¨Ù…Ø§Ù†ÙŠØ¯.', 'error');
                return;
            }

            const name = document.getElementById('engineerName').value.trim();
            const rank = document.getElementById('engineerRank').value;

            if (name === "" || rank === "") {
                showMessage('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÙŠÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÙŠØ¯.', 'error');
                return;
            }
            
            const newEngineer = {
                name: name,
                rank: rank,
                quotaMax: RANK_QUOTAS[rank] || 0,
                debt: 0,
                lastAssignedProject: null,
                userId: userId, // Ù…Ø§Ù„Ú©ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ø§Ø¯Ù…ÛŒÙ†
                createdAt: serverTimestamp(),
            };

            try {
                await addDoc(ENGINEER_COLLECTION, newEngineer);
                showMessage(`Ù…Ù‡Ù†Ø¯Ø³ ${name} Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø«Ø¨Øª Ø´Ø¯.`, 'success');
                document.getElementById('addEngineerForm').reset();
                showView('dashboardView');
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³: ", error);
                showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù…Ù‡Ù†Ø¯Ø³. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÙŠØ¯.', 'error');
            }
        });


        // Project Assignment
        document.getElementById('assignProjectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isAuthReady) {
                showMessage('Ù„Ø·ÙØ§Ù‹ Ù…Ù†ØªØ¸Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÙŠØª Ø¨Ù…Ø§Ù†ÙŠØ¯.', 'error');
                return;
            }
            
            const jobType = document.getElementById('jobType').value;
            const clientName = document.getElementById('clientName').value.trim();
            const projectAreaEl = document.getElementById('projectArea');
            const projectArea = projectAreaEl ? parseFloat(projectAreaEl.value) : 0;
            const manualCost = parseFloat(document.getElementById('manualCost').value);
            const relatedOrganizationEl = document.getElementById('relatedOrganization');
            let organization = JOB_DETAILS[jobType].organization;

            if (organization === 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†' && relatedOrganizationEl) {
                organization = relatedOrganizationEl.value;
            } else if (organization === 'Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ú¯Ø§Ù†') {
                showMessage('Ù„Ø·ÙØ§Ù‹ Ø§Ø±Ú¯Ø§Ù† Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÙŠØ¯.', 'error');
                return;
            }

            if (jobType === "" || clientName === "" || isNaN(manualCost) || manualCost <= 0) {
                 showMessage('Ù„Ø·ÙØ§Ù‹ ØªÙ…Ø§Ù… ÙÙŠÙ„Ø¯Ù‡Ø§ÙŠ Ø§Ù„Ø²Ø§Ù…ÙŠ Ø±Ø§ Ù¾Ø± Ú©Ù†ÙŠØ¯.', 'error');
                 return;
            }
            
            // --- Assignment Logic ---
            try {
                // 1. ÙŠØ§ÙØªÙ† Ù…Ù‡Ù†Ø¯Ø³ ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÙŠØ·
                const eligibleEngineers = Object.values(allEngineersMap)
                    .filter(eng => {
                        const quotaMax = RANK_QUOTAS[eng.rank] || 0;
                        const remainingQuota = quotaMax - eng.debt;
                        return remainingQuota >= manualCost; // ÙÙ‚Ø· Ú©Ø³Ø§Ù†ÙŠ Ú©Ù‡ Ø³Ù‡Ù…ÙŠÙ‡ Ú©Ø§ÙÙŠ Ø¯Ø§Ø±Ù†Ø¯
                    })
                    .sort((a, b) => {
                        // Ø§ÙˆÙ„ÙˆÙŠØª Ø¨Ø§ Ú©Ø³Ø§Ù†ÙŠ Ú©Ù‡ Ø¨Ø¯Ù‡ÙŠ Ú©Ù…ØªØ± Ø¯Ø§Ø±Ù†Ø¯
                        return a.debt - b.debt;
                    });

                if (eligibleEngineers.length === 0) {
                    const resultDiv = document.getElementById('assignmentResult');
                    resultDiv.classList.remove('hidden', 'border-r-4', 'border-green-500');
                    resultDiv.classList.add('border-r-4', 'border-red-500');
                    document.getElementById('resultText').textContent = `Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ù‡ÙŠÚ† Ù…Ù‡Ù†Ø¯Ø³ÙŠ Ø¨Ø§ Ø³Ù‡Ù…ÙŠÙ‡ Ú©Ø§ÙÙŠ (Ø¨Ø§Ù‚ÙŠÙ…Ø§Ù†Ø¯Ù‡ Ø¨ÙŠØ´ØªØ± ÙŠØ§ Ù…Ø³Ø§ÙˆÙŠ ${formatCost(manualCost)}) ÙŠØ§ÙØª Ù†Ø´Ø¯.`;
                    showMessage('Ø®Ø·Ø§: Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ù‡Ù†Ø¯Ø³ ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÙŠØ·.', 'error');
                    return;
                }
                
                // Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ø§ Ú©Ù…ØªØ±ÙŠÙ† Ø¨Ø¯Ù‡ÙŠ Ø§Ø² Ø¨ÙŠÙ† ÙˆØ§Ø¬Ø¯ÙŠÙ† Ø´Ø±Ø§ÙŠØ·
                const assignedEngineer = eligibleEngineers[0];
                const assignedEngineerRef = doc(ENGINEER_COLLECTION, assignedEngineer.id);
                
                let resultText = '';

                // 2. Ø§Ù†Ø¬Ø§Ù… ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø±Ø§ÙŠ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÙŠ Ø³Ù‡Ù…ÙŠÙ‡ Ùˆ Ø«Ø¨Øª Ù¾Ø±ÙˆÚ˜Ù‡
                await runTransaction(db, async (transaction) => {
                    
                    // Ø§Ù„Ù. Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÙŠ Ø³Ù‡Ù…ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³
                    transaction.update(assignedEngineerRef, {
                        debt: increment(manualCost), // Ø§ÙØ²Ø§ÙŠØ´ Ø¨Ø¯Ù‡ÙŠ
                        lastAssignedProject: clientName,
                    });
                    
                    // Ø¨. Ø«Ø¨Øª Ù¾Ø±ÙˆÚ˜Ù‡
                    const newProject = {
                        jobType: jobType,
                        cost: manualCost,
                        area: projectArea,
                        clientName: clientName,
                        organization: organization,
                        engineerId: assignedEngineer.id,
                        engineerName: assignedEngineer.name,
                        engineerRank: assignedEngineer.rank,
                        userId: userId,
                        assignedAt: serverTimestamp(),
                    };
                    transaction.set(doc(PROJECTS_COLLECTION), newProject); // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² set(doc()) Ø¨Ø±Ø§ÙŠ Ø«Ø¨Øª Ø¢ÙŠØ¯ÙŠ Ø¬Ø¯ÙŠØ¯

                    resultText = `Ú©Ø§Ø± Ø¨Ù‡ Ù…Ù‡Ù†Ø¯Ø³ ${assignedEngineer.name} (${assignedEngineer.rank}) Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø§Ø±Ø¬Ø§Ø¹ Ø´Ø¯. Ø¨Ø¯Ù‡ÙŠ Ø§ÙØ²Ø§ÙŠØ´ ÙŠØ§ÙØª Ø¨Ù‡ Ù…ÙŠØ²Ø§Ù† ${formatCost(manualCost)}.`;
                });

                // 3. Ù†Ù…Ø§ÙŠØ´ Ù†ØªÙŠØ¬Ù‡ Ù…ÙˆÙÙ‚ÙŠØªâ€ŒØ¢Ù…ÙŠØ²
                const resultDiv = document.getElementById('assignmentResult');
                resultDiv.classList.remove('hidden', 'border-r-4', 'border-red-500');
                resultDiv.classList.add('border-r-4', 'border-green-500');
                document.getElementById('resultText').textContent = resultText;
                
                showMessage('Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.', 'success');
                document.getElementById('assignProjectForm').reset();
                renderDynamicInputs(null); // Clear dynamic inputs
                
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø¬Ø§Ø¹ Ù¾Ø±ÙˆÚ˜Ù‡ (ØªØ±Ø§Ú©Ù†Ø´): ", error);
                showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø¬Ø§Ø¹ Ù¾Ø±ÙˆÚ˜Ù‡. Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø³Ù‡Ù…ÙŠÙ‡ Ú©Ø§ÙÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ ÛŒØ§ Ù…Ø´Ú©Ù„ Ø´Ø¨Ú©Ù‡ Ø§Ø³Øª.', 'error');
            }
        });
        
        
        // Reset Quota (Single Engineer)
        async function resetEngineerQuota(engineerId, engineerName) {
            if (!isAuthReady) {
                showMessage('Ù„Ø·ÙØ§Ù‹ Ù…Ù†ØªØ¸Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÙŠØª Ø¨Ù…Ø§Ù†ÙŠØ¯.', 'error');
                return;
            }
            
            const engineerRef = doc(ENGINEER_COLLECTION, engineerId);
            
            try {
                await updateDoc(engineerRef, {
                    debt: 0, // ØµÙØ± Ú©Ø±Ø¯Ù† Ø¨Ø¯Ù‡ÛŒ
                    lastResetAt: serverTimestamp(),
                });
                showMessage(`Ø¨Ø¯Ù‡ÙŠ Ù…Ù‡Ù†Ø¯Ø³ ${engineerName} Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª ØªØ³ÙˆÙŠÙ‡ Ø´Ø¯.`, 'success');
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± ØªØ³ÙˆÙŠÙ‡ Ø³Ù‡Ù…ÙŠÙ‡: ", error);
                showMessage(`Ø®Ø·Ø§ Ø¯Ø± ØªØ³ÙˆÙŠÙ‡ Ø³Ù‡Ù…ÙŠÙ‡ Ù…Ù‡Ù†Ø¯Ø³ ${engineerName}.`, 'error');
            } finally {
                closeModal('confirmationModal');
            }
        }
        
        // Reset All Quotas
        async function resetAllQuotas() {
             if (!isAuthReady) {
                showMessage('Ù„Ø·ÙØ§Ù‹ Ù…Ù†ØªØ¸Ø± Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÙŠØª Ø¨Ù…Ø§Ù†ÙŠØ¯.', 'error');
                return;
            }
            
            closeModal('confirmationModal');
            showMessage('Ø¯Ø± Ø­Ø§Ù„ ØªØ³ÙˆÙŠÙ‡ Ø¨Ø¯Ù‡ÙŠ Ù‡Ù…Ù‡ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†...', 'info');

            try {
                const batch = writeBatch(db);
                let count = 0;
                
                for (const id in allEngineersMap) {
                    const eng = allEngineersMap[id];
                    if (eng.debt > 0) {
                         const engineerRef = doc(ENGINEER_COLLECTION, id);
                         batch.update(engineerRef, {
                             debt: 0,
                             lastResetAt: serverTimestamp(),
                         });
                         count++;
                    }
                }
                
                if (count > 0) {
                     await batch.commit();
                     showMessage(`${count} Ø¨Ø¯Ù‡ÙŠ Ù…Ù‡Ù†Ø¯Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÙŠØª ØªØ³ÙˆÙŠÙ‡ Ùˆ Ø³Ù‡Ù…ÙŠÙ‡ Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ø² Ø´Ø¯.`, 'success');
                } else {
                     showMessage('Ø¨Ø¯Ù‡ÙŠ Ø¨Ø±Ø§ÙŠ ØªØ³ÙˆÙŠÙ‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´Øª.', 'info');
                }
                
            } catch (error) {
                 console.error("Ø®Ø·Ø§ Ø¯Ø± ØªØ³ÙˆÙŠÙ‡ Ø¯Ø³ØªÙ‡â€ŒØ§ÙŠ Ø³Ù‡Ù…ÙŠÙ‡â€ŒÙ‡Ø§: ", error);
                 showMessage('Ø®Ø·Ø§ Ø¯Ø± ØªØ³ÙˆÙŠÙ‡ Ø¯Ø³ØªÙ‡â€ŒØ§ÙŠ. Ø¹Ù…Ù„ÙŠØ§Øª Ù„ØºÙˆ Ø´Ø¯.', 'error');
            }
        }
        
        
        // ====================================================================
        // === MODAL & REPORTING FUNCTIONS ===
        // ====================================================================

        // Confirmation Modal Handler
        window.showConfirmation = function(action, id = null, name = null) {
            const confirmModalTitle = document.getElementById('confirmModalTitle');
            const confirmModalMessage = document.getElementById('confirmModalMessage');
            const confirmAcceptBtn = document.getElementById('confirmAcceptBtn');
            
            openModal('confirmationModal');
            
            if (action === 'resetQuota') {
                confirmModalTitle.textContent = `ØªØ³ÙˆÙŠÙ‡ Ø¨Ø¯Ù‡ÙŠ Ù…Ù‡Ù†Ø¯Ø³ ${name}`;
                confirmModalMessage.innerHTML = `Ø¢ÙŠØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÙŠØ¯ Ú©Ù‡ Ø¨Ø¯Ù‡ÙŠ Ù…Ù‡Ù†Ø¯Ø³ **${name}** (Ø¨Ø§ Ù…Ø¨Ù„Øº ${formatCost(allEngineersMap[id]?.debt || 0)}) ØªØ³ÙˆÙŠÙ‡ Ø´Ø¯Ù‡ Ùˆ Ø³Ù‡Ù…ÙŠÙ‡ Ø§Ùˆ ØµÙØ± Ø´ÙˆØ¯ØŸ`;
                confirmAcceptBtn.onclick = () => resetEngineerQuota(id, name);
                confirmAcceptBtn.textContent = 'ØªØ³ÙˆÙŠÙ‡ Ú©Ù†';
            } else if (action === 'resetAllQuotas') {
                confirmModalTitle.textContent = 'ØªØ³ÙˆÙŠÙ‡ Ø¯Ø³ØªÙ‡â€ŒØ§ÙŠ Ø³Ù‡Ù…ÙŠÙ‡â€ŒÙ‡Ø§';
                confirmModalMessage.textContent = 'Ø¢ÙŠØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÙŠØ¯ Ú©Ù‡ Ø¨Ø¯Ù‡ÙŠ ØªÙ…Ø§Ù… Ù…Ù‡Ù†Ø¯Ø³Ø§Ù†ÛŒ Ú©Ù‡ Ø¨Ø¯Ù‡Ú©Ø§Ø± Ù‡Ø³ØªÙ†Ø¯ØŒ ØªØ³ÙˆÙŠÙ‡ Ø´Ø¯Ù‡ Ùˆ Ø³Ù‡Ù…ÙŠÙ‡ Ø¢Ù†â€ŒÙ‡Ø§ ØµÙØ± Ø´ÙˆØ¯ØŸ Ø§ÙŠÙ† Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø±Ú¯Ø´Øªâ€ŒÙ†Ø§Ù¾Ø°ÙŠØ± Ø§Ø³Øª.';
                confirmAcceptBtn.onclick = resetAllQuotas;
                confirmAcceptBtn.textContent = 'ØªØ£ÙŠÙŠØ¯ ØªØ³ÙˆÙŠÙ‡ Ø¹Ù…ÙˆÙ…ÙŠ';
            }
        }
        
        // Show Engineer Projects in Modal
        window.showEngineerProjects = async function(engineerId, engineerName) {
            openModal('detailsModal');
            modalTitleRef.textContent = `Ø¬Ø²Ø¦ÙŠØ§Øª Ú©Ø§Ø±Ù‡Ø§ÙŠ Ù…Ù‡Ù†Ø¯Ø³: ${engineerName}`;
            projectsListRef.innerHTML = '';
            modalLoadingMessageRef.classList.remove('hidden');

            try {
                // ÙÙŠÙ„ØªØ± Ú©Ø±Ø¯Ù† Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ engineerId Ø§Ø² Ù„ÙŠØ³Øª Ú©Ø´ Ø´Ø¯Ù‡ allProjects
                const engineerProjects = allProjects
                    .filter(p => p.engineerId === engineerId)
                    .sort((a, b) => (b.assignedAt?.toMillis() || 0) - (a.assignedAt?.toMillis() || 0)); // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÙŠ Ø§Ø² Ø¬Ø¯ÙŠØ¯ Ø¨Ù‡ Ù‚Ø¯ÙŠÙ…

                modalLoadingMessageRef.classList.add('hidden');
                
                if (engineerProjects.length === 0) {
                    projectsListRef.innerHTML = '<p class="text-center text-gray-500 p-4">Ù‡ÙŠÚ† Ú©Ø§Ø±ÙŠ Ø¨Ø±Ø§ÙŠ Ø§ÙŠÙ† Ù…Ù‡Ù†Ø¯Ø³ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
                    return;
                }

                let projectsHtml = '';
                engineerProjects.forEach(p => {
                    const assignedDate = p.assignedAt ? new Date(p.assignedAt.toMillis()).toLocaleDateString('fa-IR') : 'Ù†Ø§Ù…Ø´Ø®Øµ';
                    const area = p.area ? `${p.area} Ù….Ù…` : '---';
                    
                    projectsHtml += `
                        <div class="p-3 border rounded-lg bg-gray-50 hover:bg-gray-100 transition">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-bold text-gray-800">${p.jobType}</span>
                                <span class="text-sm font-semibold text-blue-700">${formatCost(p.cost)}</span>
                            </div>
                            <p class="text-xs text-gray-600">
                                Ù…ØªÙ‚Ø§Ø¶ÙŠ: ${p.clientName} | 
                                Ø§Ø±Ú¯Ø§Ù†: ${p.organization} |
                                Ù…ØªØ±Ø§Ú˜: ${area} |
                                ØªØ§Ø±ÙŠØ®: ${assignedDate}
                            </p>
                        </div>
                    `;
                });
                
                projectsListRef.innerHTML = projectsHtml;

            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ø¬Ø²Ø¦ÙŠØ§Øª Ù¾Ø±ÙˆÚ˜Ù‡: ", error);
                modalLoadingMessageRef.classList.add('hidden');
                projectsListRef.innerHTML = '<p class="text-center text-red-500 p-4">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÙŠ Ø§Ø·Ù„Ø§Ø¹Ø§Øª.</p>';
            }
        }
        
        
        // Show Monthly Report
        function showMonthlyReport() {
            openModal('printReportModal');
            const reportArea = document.getElementById('printReportArea');
            reportArea.innerHTML = '<div class="text-center p-8 text-gray-500">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÙŠ Ú¯Ø²Ø§Ø±Ø´...</div>';
            
            // 1. ÙÙŠÙ„ØªØ± Ú©Ø±Ø¯Ù† Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§ÙŠ Ø§ÙŠÙ† Ù…Ø§Ù‡
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const monthlyProjects = allProjects.filter(p => {
                const projectDate = p.assignedAt ? new Date(p.assignedAt.toMillis()) : null;
                return projectDate && projectDate >= startOfMonth;
            });
            
            // 2. Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø±
            const stats = {
                totalProjects: monthlyProjects.length,
                totalCost: monthlyProjects.reduce((sum, p) => sum + (p.cost || 0), 0),
                engineerAssignments: {}, // { engineerId: count }
            };
            
            monthlyProjects.forEach(p => {
                stats.engineerAssignments[p.engineerId] = (stats.engineerAssignments[p.engineerId] || 0) + 1;
            });
            
            // 3. Ø³Ø§Ø®Øª Ø¬Ø¯ÙˆÙ„ Ú¯Ø²Ø§Ø±Ø´
            let reportHtml = `
                <div class="print-only text-center my-4">
                    <h2 class="text-2xl font-bold">Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø§Ù…Ø¹ Ø§Ø±Ø¬Ø§Ø¹Ø§Øª Ú©Ø§Ø± Ù…Ø§Ù‡ÙŠØ§Ù†Ù‡</h2>
                    <p class="text-sm mt-1">ØªØ§Ø±ÙŠØ® Ú¯Ø²Ø§Ø±Ø´: ${new Date().toLocaleDateString('fa-IR')} | Ø§Ø² Ø§Ø¨ØªØ¯Ø§ÙŠ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÙŠ</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center print:border-b print:pb-4">
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <p class="text-sm text-blue-800">ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø§Ø±Ø¬Ø§Ø¹Ø§Øª</p>
                        <p class="text-xl font-bold text-blue-900">${stats.totalProjects}</p>
                    </div>
                    <div class="p-3 bg-green-100 rounded-lg">
                        <p class="text-sm text-green-800">Ù…Ø¬Ù…ÙˆØ¹ Ù‡Ø²ÙŠÙ†Ù‡ Ø§Ø±Ø¬Ø§Ø¹ Ø´Ø¯Ù‡</p>
                        <p class="text-xl font-bold text-green-900">${formatCost(stats.totalCost)}</p>
                    </div>
                    <div class="p-3 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-800">ØªØ¹Ø¯Ø§Ø¯ Ù…Ù‡Ù†Ø¯Ø³Ø§Ù† Ø¯Ø±Ú¯ÙŠØ±</p>
                        <p class="text-xl font-bold text-gray-900">${Object.keys(stats.engineerAssignments).length}</p>
                    </div>
                </div>

                <h3 class="text-xl font-bold text-gray-800 mb-3 print:mt-4">Ù„ÙŠØ³Øª ØªÙØµÙŠÙ„ÙŠ Ø§Ø±Ø¬Ø§Ø¹Ø§Øª Ù…Ø§Ù‡ÙŠØ§Ù†Ù‡</h3>
                <div class="overflow-x-auto">
                    <table class="report-table w-full text-sm">
                        <thead class="bg-blue-100 text-blue-800">
                            <tr>
                                <th class="p-2">ØªØ§Ø±ÙŠØ®</th>
                                <th>Ù…Ù‡Ù†Ø¯Ø³</th>
                                <th>Ù¾Ø§ÙŠÙ‡</th>
                                <th>Ù†ÙˆØ¹ Ú©Ø§Ø±</th>
                                <th>Ù…ØªØ±Ø§Ú˜/Ù…Ø³Ø§Ø­Øª</th>
                                <th>Ù…ØªÙ‚Ø§Ø¶ÙŠ</th>
                                <th>Ù‡Ø²ÙŠÙ†Ù‡ (Ù….Øª)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            if (monthlyProjects.length === 0) {
                reportHtml += `
                    <tr>
                        <td colspan="7" class="text-center p-4 text-gray-500">Ù‡ÙŠÚ† Ø§Ø±Ø¬Ø§Ø¹ Ú©Ø§Ø±ÙŠ Ø¯Ø± Ù…Ø§Ù‡ Ø¬Ø§Ø±ÙŠ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</td>
                    </tr>
                `;
            } else {
                monthlyProjects.forEach(p => {
                    const assignedDate = p.assignedAt ? new Date(p.assignedAt.toMillis()).toLocaleDateString('fa-IR') : '---';
                    const area = p.area ? `${new Intl.NumberFormat('fa-IR').format(p.area)} Ù….Ù…` : '---';
                    
                    reportHtml += `
                        <tr>
                            <td>${assignedDate}</td>
                            <td>${p.engineerName}</td>
                            <td>${p.engineerRank}</td>
                            <td>${p.jobType}</td>
                            <td>${area}</td>
                            <td>${p.clientName}</td>
                            <td class="font-bold">${formatCost(p.cost).replace(' Ù….Øª', '')}</td>
                        </tr>
                    `;
                });
            }

            reportHtml += `
                        </tbody>
                        <tfoot class="bg-gray-200 font-bold">
                            <tr>
                                <td colspan="6" class="text-left">Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„ Ù‡Ø²ÙŠÙ†Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ù…Ø§Ù‡ Ø¬Ø§Ø±ÙŠ</td>
                                <td>${formatCost(stats.totalCost).replace(' Ù….Øª', '')}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            reportArea.innerHTML = reportHtml;
            
            // ØªØ§Ø¨Ø¹ Ú†Ø§Ù¾ Ø³Ø±Ø§Ø³Ø±ÛŒ Ø±Ø§ ØªØ¹Ø±ÛŒÙ Ú©Ù†ÛŒØ¯
            window.printReport = function() {
                // hide print-only element for initial view, then show for print
                document.querySelectorAll('.print-only').forEach(el => el.style.display = 'block');
                
                const originalDisplay = document.body.style.display;
                document.body.style.display = 'none'; // hide main body
                
                const reportContent = document.getElementById('reportContentContainer').innerHTML;
                const printWindow = window.open('', '', 'height=600,width=800');
                
                printWindow.document.write('<html><head><title>Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡ÙŠØ§Ù†Ù‡</title>');
                // Inject custom print styles
                printWindow.document.write('<style>');
                printWindow.document.write(document.querySelector('style').textContent);
                printWindow.document.write('</style>');
                printWindow.document.write('</head><body>');
                printWindow.document.write(reportContent);
                printWindow.document.write('</body></html>');
                
                printWindow.document.close();
                printWindow.print();
                
                // Note: The print modal will be closed manually by user when print dialog is closed
            }
        }

    </script>
</body>
</html>
