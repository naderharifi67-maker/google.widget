<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تابلوی پیام اشتراکی</title>
    <!-- بارگذاری Tailwind CSS برای استایل‌دهی آسان و مدرن -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- بارگذاری فونت Inter (و تلاش برای استفاده از فونت‌های سیستمی فارسی) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', Tahoma, Arial, "Helvetica Neue", Helvetica, sans-serif;
            background-color: #f3f4f6; /* پس‌زمینه خاکستری روشن */
        }
        /* استایل سفارشی برای نوار پیام‌ها که قابلیت اسکرول داشته باشد */
        #messages-container {
            max-height: 70vh; /* حداکثر ارتفاع ۷۰٪ ویوپورت */
            overflow-y: auto; /* فعال کردن اسکرول عمودی */
            padding-left: 0.5rem; /* پدینگ برای زیبایی اسکرول‌بار */
        }
        /* استایل برای خود پیام‌ها */
        .message-bubble {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
    </style>
</head>
<body>

    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- عنوان اصلی -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-800">✉️ تابلوی پیام عمومی</h1>
            <p class="text-gray-500 mt-2">پیامی بنویسید تا همه کسانی که این صفحه را باز می‌کنند، آن را به صورت لحظه‌ای ببینند.</p>
        </header>
        
        <!-- جعبه نمایش خطاهای حیاتی (جدید) -->
        <div id="global-error" class="bg-red-100 border-r-4 border-red-500 text-red-700 p-4 mb-4 rounded-lg shadow-md hidden" role="alert">
            <p class="font-bold">خطای حیاتی در اتصال:</p>
            <p id="error-details" class="text-sm mt-1"></p>
        </div>

        <!-- وضعیت اتصال و شناسه کاربری -->
        <div id="status-bar" class="text-center mb-4 p-2 bg-indigo-100 text-indigo-700 rounded-lg shadow-sm hidden">
            <span id="auth-status">در حال اتصال...</span>
            <span class="inline-block mx-2">|</span>
            <span id="user-id-display" class="text-sm font-mono">شناسه کاربری: ---</span>
        </div>
        
        <!-- کانتینر پیام‌ها -->
        <div id="messages-container" class="bg-white rounded-xl shadow-lg p-4 mb-6 border border-gray-200">
            <!-- پیام‌ها به صورت پویا در اینجا بارگذاری می‌شوند -->
            <p id="loading-message" class="text-center text-gray-400 p-4">در حال بارگذاری پیام‌ها...</p>
        </div>

        <!-- فرم ارسال پیام -->
        <div class="bg-white p-4 md:p-6 rounded-xl shadow-2xl border border-indigo-200">
            <form id="message-form" class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3 rtl:space-x-reverse">
                <input
                    type="text"
                    id="message-input"
                    placeholder="پیام خود را اینجا بنویسید..."
                    required
                    maxlength="500"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-base transition duration-150"
                    aria-label="ورودی پیام جدید"
                >
                <button
                    type="submit"
                    id="send-button"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200 ease-in-out transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    ارسال پیام
                </button>
            </form>
            <p id="form-error-message" class="text-red-500 mt-2 text-sm hidden">خطا در ارسال پیام. لطفاً دوباره تلاش کنید.</p>
        </div>
    </div>

    <!-- اسکریپت‌های Firebase -->
    <script type="module">
        // وارد کردن ماژول‌های لازم از Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // بازگرداندن signInWithCustomToken برای استفاده از توکن محیط کاری
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // تنظیمات عمومی Firebase (توسط محیط کاری فراهم می‌شود)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        let db, auth, userId = null; 
        let isListenerSetup = false; 
        const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;

        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const messagesContainer = document.getElementById('messages-container');
        const loadingMessage = document.getElementById('loading-message');
        const authStatus = document.getElementById('auth-status');
        const userIdDisplay = document.getElementById('user-id-display');
        const statusBar = document.getElementById('status-bar'); // <-- اصلاح: تعریف متغیر statusBar
        
        // عناصر جدید نمایش خطا
        const globalErrorDiv = document.getElementById('global-error');
        const errorDetailsP = document.getElementById('error-details');
        const formErrorElement = document.getElementById('form-error-message');


        // فعال کردن لاگ‌های دیباگ (برای رفع مشکلات مجوز)
        setLogLevel('debug'); 

        // --- توابع کمکی ---

        // تابع نمایش خطای عمومی
        function displayGlobalError(message) {
            errorDetailsP.textContent = message;
            globalErrorDiv.classList.remove('hidden');
        }

        // تابع برای تبدیل زمان‌بندی Firebase به یک رشته قابل خواندن 
        function formatTimestamp(timestamp) {
            if (timestamp && timestamp.toDate) {
                const date = timestamp.toDate();
                const options = { 
                    year: 'numeric', month: 'short', day: 'numeric', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit', 
                    hour12: false 
                };
                return date.toLocaleDateString('fa-IR', options);
            }
            return 'همین الان';
        }

        // تابع برای رندر کردن یک لیست از پیام‌ها
        function renderMessages(messages) {
            messagesContainer.innerHTML = ''; // پاک کردن پیام‌های قبلی
            if (messages.length === 0) {
                const loadingMsg = document.getElementById('loading-message');
                if (loadingMsg) loadingMsg.remove();
                messagesContainer.innerHTML = '<p class="text-center text-gray-400 p-4">هنوز پیامی ارسال نشده است. اولین پیام را شما بنویسید!</p>';
                return;
            }

            // پیمایش پیام‌ها و ایجاد حباب‌های پیام
            messages.forEach(msg => {
                // مقایسه با شناسه موقت کاربر فعلی
                const isMine = msg.userId === userId;
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message-bubble p-3 rounded-xl mb-3 max-w-[90%] md:max-w-[75%] transition duration-300 ${isMine ? 'bg-indigo-500 text-white ml-auto' : 'bg-gray-100 text-gray-800 mr-auto'}`;
                
                // اطلاعات کاربر
                const userSpan = document.createElement('span');
                userSpan.className = `font-bold text-xs ${isMine ? 'text-indigo-200' : 'text-indigo-600'}`;
                // نمایش "شما" اگر شناسه پیام با شناسه کاربر احراز هویت شده یکسان باشد
                userSpan.textContent = isMine ? 'شما (احراز هویت شده)' : `کاربر: ${msg.userId.substring(0, 8)}...`;
                
                // محتوای پیام
                const contentP = document.createElement('p');
                contentP.className = 'text-sm mt-1 mb-2 whitespace-pre-wrap';
                contentP.textContent = msg.text;

                // زمان ارسال
                const timeSpan = document.createElement('span');
                timeSpan.className = `block text-xs text-opacity-75 ${isMine ? 'text-white' : 'text-gray-500'} text-left`;
                timeSpan.textContent = formatTimestamp(msg.timestamp);

                messageDiv.appendChild(userSpan);
                messageDiv.appendChild(contentP);
                messageDiv.appendChild(timeSpan);
                messagesContainer.appendChild(messageDiv);
            });

            // اسکرول به پایین‌ترین پیام
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // --- توابع Firebase و منطق برنامه ---

        async function initializeFirebase() {
            try {
                authStatus.textContent = 'در حال راه‌اندازی Firebase...';
                
                // 1. راه‌اندازی برنامه و سرویس‌ها
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app); 
                
                // 2. تنظیم شنونده وضعیت احراز هویت
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // احراز هویت موفقیت‌آمیز است
                        userId = user.uid; // استفاده از شناسه واقعی Firebase
                        userIdDisplay.textContent = `شناسه کاربری: ${userId.substring(0, 8)}...`;
                        authStatus.textContent = 'متصل به سرور و احراز هویت شده.';
                        statusBar.classList.remove('hidden'); // <-- در اینجا استفاده می‌شود
                        sendButton.disabled = false;
                        globalErrorDiv.classList.add('hidden'); // پاک کردن خطای احراز هویت در صورت موفقیت
                        
                        // فقط در صورتی شنونده را راه‌اندازی کن که قبلاً انجام نشده باشد
                        if (!isListenerSetup) {
                            setupRealtimeListener(); 
                        }
                    } else {
                        // احراز هویت ناموفق یا در حال انتظار
                        userId = null;
                        authStatus.textContent = 'در حال تلاش برای احراز هویت...';
                        sendButton.disabled = true;
                    }
                });

                // 3. تلاش برای احراز هویت با توکن سفارشی (اولویت بالاتر) یا به صورت ناشناس
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("خطا در راه‌اندازی Firebase:", error);
                authStatus.textContent = 'خطا در اتصال: ' + error.message;
                displayGlobalError(`خطای احراز هویت (Auth): ${error.message}`); // نمایش خطای دقیق Auth
            }
        }

        function setupRealtimeListener() {
            if (!db || !userId || isListenerSetup) return; // بازبینی پرچم
            isListenerSetup = true; // تنظیم پرچم برای جلوگیری از اجرای تکراری

            // ساخت کوئری: گرفتن مجموعه پیام‌ها و مرتب‌سازی بر اساس زمان ارسال
            const messagesQuery = query(
                collection(db, messagesCollectionPath),
                orderBy('timestamp', 'asc') 
            );
            
            // گوش دادن به تغییرات در لحظه
            const unsubscribe = onSnapshot(messagesQuery, (snapshot) => {
                // اگر پیام بارگذاری شده باشد، پیام "در حال بارگذاری" را حذف کن
                const loadingMsg = document.getElementById('loading-message');
                if (loadingMsg) loadingMsg.remove();
                
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });

                renderMessages(messages);
            }, (error) => {
                console.error("خطا در دریافت لحظه‌ای پیام‌ها:", error);
                // نمایش خطای مجوز در صورت بروز مجدد
                if (error.code === 'permission-denied') {
                    const errorMessage = `خطای مجوز Firestore: ${error.message}`;
                    messagesContainer.innerHTML = `<p class="text-center text-red-500 p-4">خطا: مجوز دسترسی به پیام‌ها وجود ندارد.</p>`;
                    displayGlobalError(errorMessage); // نمایش خطای دقیق Firestore
                } else {
                    messagesContainer.innerHTML = `<p class="text-center text-red-500 p-4">خطا در بارگذاری پیام‌ها: ${error.message}</p>`;
                    displayGlobalError(`خطای عمومی Firestore: ${error.message}`); // نمایش خطای عمومی
                }
            });

            // برگرداندن تابع لغو اشتراک در صورت نیاز
            return unsubscribe;
        }

        // تابع مدیریت ارسال پیام
        document.getElementById('message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();

            if (!text || !db || !userId) {
                formErrorElement.textContent = 'برای ارسال پیام، اتصال برقرار و متن پیام باید وجود داشته باشد.';
                formErrorElement.classList.remove('hidden');
                return;
            }
            
            formErrorElement.classList.add('hidden');
            sendButton.disabled = true;

            const newMessage = {
                text: text,
                userId: userId, 
                timestamp: serverTimestamp() // زمان‌بندی از سرور برای جلوگیری از خطا
            };

            try {
                await addDoc(collection(db, messagesCollectionPath), newMessage);
                messageInput.value = ''; // خالی کردن فیلد
            } catch (error) {
                console.error("خطا در ارسال پیام:", error);
                const errorMessage = `خطا در ارسال پیام (Firestore): ${error.message}`;
                formErrorElement.textContent = errorMessage;
                formErrorElement.classList.remove('hidden');
                displayGlobalError(errorMessage); // نمایش خطای دقیق ارسال
            } finally {
                sendButton.disabled = false;
            }
        });

        // --- شروع برنامه ---

        // شروع فرآیند راه‌اندازی
        initializeFirebase();

    </script>
</body>
</html>
